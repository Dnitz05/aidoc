<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
      /* Estils Base */
      body { padding: 0; margin: 0; font-family: 'Google Sans', Roboto, Arial; background: #f8f9fa; height: 100vh; display: flex; flex-direction: column; }

      /* Tabs */
      .tabs { display: flex; background: white; border-bottom: 1px solid #ddd; }
      .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; color: #5f6368; font-weight: 500; font-size: 14px; border-bottom: 2px solid transparent; }
      .tab.active { color: #1a73e8; border-bottom: 2px solid #1a73e8; }

      /* Panels */
      .content-panel { flex-grow: 1; display: none; overflow-y: auto; padding: 15px; }
      .content-panel.active { display: flex; flex-direction: column; }

      /* Xat */
      #chatHistory { flex-grow: 1; display: flex; flex-direction: column; gap: 12px; margin-bottom: 10px; }
      .msg { padding: 10px 14px; border-radius: 18px; font-size: 13px; line-height: 1.4; max-width: 85%; }
      .msg.user { align-self: flex-end; background: #d2e3fc; color: #174ea6; border-bottom-right-radius: 4px; }
      .msg.ai { align-self: flex-start; background: white; border: 1px solid #dadce0; border-bottom-left-radius: 4px; }
      .msg.system { align-self: center; font-size: 11px; color: #666; width: 100%; text-align: center; margin-top: 10px; }
      .msg.error { align-self: center; background: #fce8e6; color: #c5221f; border: 1px solid #f5c6cb; }

      /* BADGE D'EDICIÃ“ */
      .edit-badge {
        display: inline-block; font-size: 10px; font-weight: bold; color: #137333;
        background-color: #e6f4ea; padding: 2px 6px; border-radius: 4px;
        margin-bottom: 6px; border: 1px solid #ceead6;
      }

      /* Controls Cervell */
      .form-group { margin-bottom: 15px; }
      label { display: block; font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #3c4043; }
      textarea, input[type="text"] { width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; }
      .file-box { border: 1px dashed #dadce0; padding: 15px; text-align: center; border-radius: 4px; background: white; }
      .checkbox-group { display: flex; align-items: center; gap: 8px; background: #fff; padding: 10px; border: 1px solid #dadce0; border-radius: 4px; }

      /* Footer */
      .footer { padding: 10px; background: white; border-top: 1px solid #ddd; }
      .input-wrapper { display: flex; gap: 8px; }
      textarea#userInput { height: 38px; border-radius: 20px; resize: none; }
      button.send-btn { background: #1a73e8; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
      button.action-btn { background: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 500; }
      button.secondary { background: #f1f3f4; color: #3c4043; margin-top: 5px; }

      .hidden { display: none !important; }
    </style>
  </head>
  <body>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('chat')">Xat</div>
      <div class="tab" onclick="switchTab('brain')">Cervell</div>
    </div>

    <div id="chatPanel" class="content-panel active">
      <div id="chatHistory">
        <div class="msg system">Hola! Soc SideCar.</div>
      </div>
    </div>

    <div id="brainPanel" class="content-panel">
      <div class="form-group">
        <label>Llicencia API</label>
        <input type="text" id="licenseKey" placeholder="SIDECAR-...">
      </div>

      <div class="form-group">
        <label>Guia d'Estil</label>
        <textarea id="styleGuide" placeholder="Ex: Sigues formal, no usis emojis..."></textarea>
      </div>

      <div class="form-group">
        <label>Fitxer de Coneixement (PDF/TXT)</label>
        <div class="file-box">
          <input type="file" id="fileInput" accept=".pdf,.txt,.csv,.md">
          <div id="fileStatus" style="margin-top:5px; font-size:11px; color:#666;">Cap fitxer seleccionat</div>
          <button class="action-btn secondary" style="margin-top:10px;" onclick="uploadFile()">Pujar Fitxer</button>
          <button class="action-btn secondary" style="margin-top:5px; color:red;" onclick="clearFile()">Esborrar</button>
        </div>
      </div>

      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="strictMode">
          <div>
            <label style="margin:0">Mode Estricte</label>
            <div style="font-size:10px; color:#666;">Nomes respon amb info del Fitxer/Context.</div>
          </div>
        </div>
      </div>

      <button class="action-btn" onclick="saveSettings()">Desar Configuracio</button>
      <div id="saveStatus" style="text-align:center; font-size:12px; margin-top:5px; color:#188038;"></div>
    </div>

    <div id="footerBar" class="footer">
      <div class="input-wrapper">
        <textarea id="userInput" placeholder="Escriu aqui..."></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">&#10148;</button>
      </div>
      <div id="creditsDisplay" style="text-align:center; font-size:10px; color:#999; margin-top:5px;"></div>
    </div>

    <script>
      let currentSettings = {};

      window.onload = function() {
        google.script.run.withSuccessHandler(function(jsonStr) {
          currentSettings = JSON.parse(jsonStr);
          document.getElementById('licenseKey').value = currentSettings.license_key || "";
          document.getElementById('styleGuide').value = currentSettings.style_guide || "";
          document.getElementById('strictMode').checked = currentSettings.strict_mode || false;
          if (!currentSettings.license_key) switchTab('brain');
        }).getSettings();

        google.script.run.withSuccessHandler(function(info) {
          if (info.hasFile) document.getElementById('fileStatus').innerText = "Actiu: " + info.name;
        }).getKnowledgeFileInfo();

        document.getElementById('userInput').addEventListener("keydown", function(e) {
          if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
      };

      function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
        if (tabName === 'chat') {
          document.querySelector('.tab:first-child').classList.add('active');
          document.getElementById('chatPanel').classList.add('active');
          document.getElementById('footerBar').classList.remove('hidden');
        } else {
          document.querySelector('.tab:last-child').classList.add('active');
          document.getElementById('brainPanel').classList.add('active');
          document.getElementById('footerBar').classList.add('hidden');
        }
      }

      function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) return alert("Selecciona un fitxer primer.");

        const file = fileInput.files[0];
        if (file.size > 10 * 1024 * 1024) return alert("Maxim 10MB per ara.");

        document.getElementById('fileStatus').innerText = "Pujant " + file.name + "...";

        const reader = new FileReader();
        reader.onload = function(e) {
          const base64 = e.target.result.split(',')[1];
          google.script.run
            .withSuccessHandler(function(res) {
              document.getElementById('fileStatus').innerText = "Actiu: " + res.name;
              alert("Fitxer connectat al cervell!");
            })
            .withFailureHandler(function(err) {
              document.getElementById('fileStatus').innerText = "Error en pujada";
              alert("Error: " + err.message);
            })
            .uploadFileToWorker(base64, file.type, file.name);
        };
        reader.readAsDataURL(file);
      }

      function clearFile() {
        google.script.run.withSuccessHandler(() => {
          document.getElementById('fileStatus').innerText = "Cap fitxer seleccionat";
        }).clearKnowledgeFile();
      }

      function saveSettings() {
        const btn = document.querySelector('.action-btn');
        btn.disabled = true;
        btn.innerText = "Desant...";
        const newSettings = {
          license_key: document.getElementById('licenseKey').value,
          style_guide: document.getElementById('styleGuide').value,
          strict_mode: document.getElementById('strictMode').checked
        };
        google.script.run.withSuccessHandler(function() {
          btn.disabled = false;
          btn.innerText = "Desar Configuracio";
          document.getElementById('saveStatus').innerText = "Guardat!";
          setTimeout(() => { document.getElementById('saveStatus').innerText = ""; }, 2000);
          currentSettings = newSettings;
        }).saveSettings(JSON.stringify(newSettings));
      }

      function sendMessage() {
        var input = document.getElementById('userInput');
        var text = input.value.trim();
        if (!text) return;
        addBubble('user', text);
        input.value = '';
        var btn = document.getElementById('sendBtn');
        btn.disabled = true;

        google.script.run
          .withSuccessHandler(function(res) {
            btn.disabled = false;
            // BADGE: res.mode ve del Code.gs ('chat' o 'edit')
            addBubble('ai', res.ai_response, res.mode === 'edit');

            if (res.credits !== undefined) {
              document.getElementById('creditsDisplay').innerText = 'Credits: ' + res.credits;
            }
          })
          .withFailureHandler(function(err) {
            btn.disabled = false;
            addBubble('error', "Error: " + err.message);
          })
          .processUserCommand(text);
      }

      function addBubble(type, text, isEdit) {
        var h = document.getElementById('chatHistory');
        var d = document.createElement('div');
        d.className = 'msg ' + type;

        // Si es resposta de la IA i es EDICIO, posem el badge
        if (type === 'ai' && isEdit) {
          d.innerHTML = '<div class="edit-badge">MODIFICACIO APLICADA</div>' + text;
        } else {
          d.innerText = text;
        }

        h.appendChild(d);
        h.scrollTop = h.scrollHeight;
      }
    </script>
  </body>
</html>
