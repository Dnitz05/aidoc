<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
      /* Estils Generals */
      body {
        padding: 0; margin: 0;
        font-family: 'Google Sans', Roboto, Arial, sans-serif;
        background-color: #f8f9fa;
        height: 100vh; display: flex; flex-direction: column;
      }

      /* Cap√ßalera */
      .header {
        background: white; padding: 12px; border-bottom: 1px solid #dadce0;
        display: flex; justify-content: space-between; align-items: center;
      }
      .header h1 { margin: 0; font-size: 16px; color: #202124; }
      .settings-btn { cursor: pointer; opacity: 0.6; font-size: 18px; }
      .settings-btn:hover { opacity: 1; }

      /* Panell de Configuraci√≥ (Ocult per defecte) */
      #configPanel {
        background: #fff; padding: 15px; border-bottom: 1px solid #ddd;
        display: none;
      }

      /* Historial del Xat */
      #chatHistory {
        flex-grow: 1; overflow-y: auto; padding: 15px;
        display: flex; flex-direction: column; gap: 12px;
      }

      /* Bombolles de missatge */
      .msg {
        padding: 10px 14px; border-radius: 18px;
        font-size: 13px; line-height: 1.4;
        max-width: 85%; word-wrap: break-word;
      }

      .msg.user {
        align-self: flex-end;
        background-color: #d2e3fc; color: #174ea6;
        border-bottom-right-radius: 4px;
      }

      .msg.ai {
        align-self: flex-start;
        background-color: #ffffff; color: #202124;
        border: 1px solid #dadce0; border-bottom-left-radius: 4px;
      }

      .msg.system {
        align-self: center; background: none; border: none;
        font-size: 11px; color: #5f6368; text-align: center; width: 100%; margin-top: 10px;
      }

      .msg.error {
        align-self: center; background-color: #fce8e6; color: #c5221f; border: 1px solid #f5c6cb;
      }

      /* Peu de p√†gina (Input) */
      .footer {
        padding: 10px; background: white; border-top: 1px solid #dadce0;
      }
      .input-wrapper { display: flex; gap: 8px; }

      textarea {
        flex-grow: 1; height: 38px; padding: 8px; resize: none;
        border: 1px solid #dadce0; border-radius: 20px; outline: none; font-family: inherit;
      }
      textarea:focus { border-color: #1a73e8; }

      button#sendBtn {
        background: #1a73e8; color: white; border: none;
        width: 40px; height: 40px; border-radius: 50%;
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        font-size: 18px; transition: background 0.2s;
      }
      button#sendBtn:hover { background: #174ea6; }
      button#sendBtn:disabled { background: #dadce0; cursor: default; }

      .credits-info { text-align: center; font-size: 10px; color: #9aa0a6; margin-top: 6px; }
    </style>
  </head>
  <body>

    <div class="header">
      <h1>SideCar ü§ñ</h1>
      <div class="settings-btn" onclick="toggleConfig()">‚öôÔ∏è</div>
    </div>

    <div id="configPanel">
      <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Llic√®ncia API</label>
      <div style="display:flex; gap:5px;">
        <input type="text" id="licenseInput" placeholder="SIDECAR-..." style="flex-grow:1; padding:5px; border:1px solid #ddd; border-radius:4px;">
        <button class="share" onclick="saveLicense()">Desar</button>
      </div>
    </div>

    <div id="chatHistory">
      <div class="msg system">Hola! Selecciona text (o res per a tot el doc) i digues-me qu√® vols fer.</div>
      <div class="msg system" style="font-size:10px;">üí° Truc: Si no selecciones res, mantindr√© les imatges i el format intactes!</div>
    </div>

    <div class="footer">
      <div class="input-wrapper">
        <textarea id="userInput" placeholder="Ex: Corregeix faltes, resumeix..."></textarea>
        <button id="sendBtn" onclick="sendMessage()">‚û§</button>
      </div>
      <div id="creditsDisplay" class="credits-info"></div>
    </div>

    <script>
      // Inicialitzaci√≥
      window.onload = function() {
        // Carregar llic√®ncia
        google.script.run.withSuccessHandler(function(key) {
          if (key) {
            document.getElementById('licenseInput').value = key;
          } else {
            toggleConfig(); // Si no n'hi ha, obrim settings
          }
        }).getLicenseKey();

        // Listener per enviar amb Enter
        var input = document.getElementById('userInput');
        input.addEventListener("keydown", function(event) {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault(); // Evita salt de l√≠nia
            sendMessage();
          }
        });
      };

      function toggleConfig() {
        var panel = document.getElementById('configPanel');
        panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
      }

      function saveLicense() {
        var key = document.getElementById('licenseInput').value;
        google.script.run.withSuccessHandler(function() {
          toggleConfig();
          addBubble('system', '‚úÖ Llic√®ncia guardada correctament.');
        }).setLicenseKey(key);
      }

      function addBubble(type, text) {
        var history = document.getElementById('chatHistory');
        var div = document.createElement('div');
        div.className = 'msg ' + type;
        div.innerText = text;
        history.appendChild(div);
        // Scroll autom√†tic al final
        history.scrollTop = history.scrollHeight;
      }

      function sendMessage() {
        var input = document.getElementById('userInput');
        var text = input.value.trim();
        if (!text) return;

        // 1. Feedback visual immediat
        addBubble('user', text);
        input.value = '';
        var btn = document.getElementById('sendBtn');
        btn.disabled = true;

        // 2. Crida al Backend (Code.gs)
        google.script.run
          .withSuccessHandler(function(res) {
            btn.disabled = false;
            addBubble('ai', res.ai_response);
            if (res.credits !== undefined) {
              document.getElementById('creditsDisplay').innerText = 'Cr√®dits restants: ' + res.credits;
            }
          })
          .withFailureHandler(function(err) {
            btn.disabled = false;
            // Missatges d'error amigables
            let errorMsg = err.message;
            if (errorMsg.includes("ScriptError")) errorMsg = "Error desconegut d'Apps Script.";
            addBubble('error', "‚ö†Ô∏è " + errorMsg);
          })
          .processUserCommand(text);
      }
    </script>
  </body>
</html>
