<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
      <?!= include("Styles") ?>
    </style>
  </head>
  <body>

    <!-- Conversations Drawer (v5.0) -->
    <div class="conversations-drawer-backdrop" id="drawerBackdrop" onclick="closeConversationsDrawer()"></div>
    <div class="conversations-drawer" id="conversationsDrawer">
      <div class="drawer-header">
        <span class="drawer-title">
          <span class="i i--accent"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
          Historial
        </span>
        <button class="drawer-close-btn" onclick="closeConversationsDrawer()">
          <span class="i i--sm"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span>
        </button>
      </div>

      <button class="new-conversation-btn" onclick="createNewConversation()">
        <span class="i i--sm"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></span>
        Nova conversa
      </button>

      <div class="conversations-search">
        <div class="conversations-search-wrapper">
          <span class="conversations-search-icon"><span class="i i--sm"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span></span>
          <input type="text" id="conversationsSearchInput" placeholder="Cerca converses..." oninput="filterConversations()">
        </div>
      </div>

      <div class="conversations-list" id="conversationsList">
        <!-- Conversations will be rendered here -->
        <div class="conversations-empty" id="conversationsEmpty">
          <div class="conversations-empty-icon"><span class="i i--xl i--muted"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span></div>
          <div class="conversations-empty-text">Cap conversa encara</div>
          <div class="conversations-empty-hint">Escriu un missatge per crear la primera conversa</div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="nav">
      <div class="nav-tabs">
        <div class="nav-pill" id="navPill"></div>
        <button class="tab active" data-tab="chat" onclick="switchTab('chat')" title="Xat">
          <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <span class="tab-label">Xat</span>
        </button>
        <button class="tab" data-tab="structure" onclick="switchTab('structure')" title="Estructura">
          <svg viewBox="0 0 24 24"><line x1="4" y1="6" x2="16" y2="6"/><line x1="4" y1="10" x2="20" y2="10"/><line x1="8" y1="14" x2="20" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></svg>
          <span class="tab-label">Estructura</span>
        </button>
        <button class="tab" data-tab="docs" onclick="switchTab('docs')" title="Coneixement">
          <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          <span class="tab-label">Docs</span>
        </button>
        <button class="tab" data-tab="recipes" onclick="switchTab('recipes')" title="Receptes">
          <svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          <span class="tab-label">Receptes</span>
        </button>
        <button class="tab" data-tab="timeline" onclick="switchTab('timeline')" title="Timeline">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <span class="tab-label">Timeline</span>
        </button>
        <button class="tab" data-tab="brain" onclick="switchTab('brain')" title="Configuració">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          <span class="tab-label">Config</span>
        </button>
      </div>
    </nav>

    <!-- Chat Panel -->
    <div id="chatPanel" class="panel active">
      <!-- Chat Header with History Button -->
      <div class="chat-header">
        <div class="chat-header-left">
          <button class="chat-history-btn" onclick="openConversationsDrawer()" title="Historial de converses">
            <span class="i i--sm"><svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span>
          </button>
          <span class="chat-current-title" id="chatCurrentTitle" onclick="editCurrentTitle()" title="Clic per editar">Nova conversa</span>
          <span class="save-indicator" id="saveIndicator"></span>
        </div>
        <button class="chat-new-btn" onclick="createNewConversation()">+ Nova</button>
      </div>
      <div class="chat-messages" id="chatHistory">
        <div class="msg system">Hola! Soc Docmile, el teu assistent d'escriptura.</div>
      </div>
    </div>

    <!-- Structure Panel (v3.9 - Document Structure) -->
    <div id="structurePanel" class="panel">
      <!-- Stats Overview -->
      <div class="structure-overview">
        <div class="structure-stats">
          <div class="stat-card">
            <div class="stat-value" id="statChars">--</div>
            <div class="stat-label">caràcters</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statParagraphs">--</div>
            <div class="stat-label">paràgrafs</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statHeadings">--</div>
            <div class="stat-label">headings</div>
          </div>
        </div>
        <div class="structure-meta" id="structureMeta">
          <span class="meta-item">Últim escaneig: mai</span>
        </div>
      </div>

      <!-- Document Outline -->
      <div class="structure-section">
        <div class="structure-section-header">
          <span class="section-title-icon i i--accent"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></span>
          <span class="section-title-text">Document Outline</span>
        </div>
        <div class="structure-search">
          <span class="search-icon i i--muted"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
          <input type="text" class="structure-search-input" id="structureSearch" placeholder="Cerca al document..." oninput="filterOutline()">
        </div>
        <div class="outline-tree" id="outlineTree">
          <div class="outline-empty">
            <span class="outline-empty-icon i i--muted"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span>
            <span>Clica "Escanejar" per veure l'estructura</span>
          </div>
        </div>
      </div>

      <!-- Entities Detected -->
      <div class="structure-section" id="entitiesSection">
        <div class="structure-section-header">
          <span class="section-title-icon i i--accent"><svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg></span>
          <span class="section-title-text">Entitats Detectades</span>
        </div>
        <div class="entities-grid" id="entitiesGrid">
          <!-- Dynamic entities -->
        </div>
      </div>

      <!-- Suggestion Card -->
      <div id="structureSuggestion" class="structure-suggestion hidden">
        <div class="suggestion-icon i i--warning i--lg"><svg viewBox="0 0 24 24"><line x1="9" y1="18" x2="15" y2="18"/><line x1="10" y1="22" x2="14" y2="22"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg></div>
        <div class="suggestion-content">
          <div class="suggestion-text" id="suggestionText"></div>
          <div class="suggestion-actions">
            <button class="suggestion-btn apply" onclick="applySuggestion()">Aplicar</button>
            <button class="suggestion-btn dismiss" onclick="dismissSuggestion()">Ignorar</button>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="structure-actions">
        <button class="btn btn-secondary" onclick="refreshStructure()">
          <span class="i i--default"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></span> Escanejar
        </button>
        <button class="btn btn-primary" onclick="runAutoStructure()">
          <span class="i i--default"><svg viewBox="0 0 24 24"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h.01"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg></span> Auto-Structure
        </button>
      </div>
    </div>

    <!-- Docs Panel (Knowledge) v5.1 - Library System -->
    <div id="docsPanel" class="panel">
      <!-- Active File Section -->
      <div class="settings-card" id="activeFileSection">
        <div class="settings-card-header">
          <span class="i i--accent"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span>
          <div>
            <div class="title">Fitxer Actiu</div>
            <div class="subtitle" id="activeFileStatus">Cap fitxer seleccionat</div>
          </div>
        </div>
        <div id="activeFileDisplay" class="knowledge-active-file hidden">
          <span class="knowledge-file-name" id="activeFileName"></span>
          <button class="knowledge-file-remove" onclick="removeActiveFile()" title="Treure">×</button>
        </div>
      </div>

      <!-- Library Section -->
      <div class="settings-card knowledge-library-card">
        <div class="settings-card-header">
          <span class="i i--default"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span>
          <div>
            <div class="title">Biblioteca</div>
            <div class="subtitle">Fitxers pujats anteriorment</div>
          </div>
          <button class="knowledge-refresh-btn" onclick="refreshKnowledgeLibrary()" title="Actualitzar">
            <span class="i i--sm"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></span>
          </button>
        </div>
        <div id="knowledgeLibraryList" class="knowledge-library-list">
          <div class="knowledge-empty">
            <span class="i i--muted"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span>
            <span>Cap fitxer a la biblioteca</span>
          </div>
        </div>
        <!-- Upload New File -->
        <div class="knowledge-upload-section">
          <label class="knowledge-upload-btn">
            <input type="file" id="fileInput" accept=".pdf,.txt,.csv,.md" onchange="handleFileSelect()">
            <span class="i i--sm"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></span>
            Pujar nou fitxer
          </label>
          <div id="fileStatusContainer"></div>
        </div>
      </div>

      <!-- Strict Mode Toggle -->
      <div class="toggle-row">
        <div class="toggle-label">
          <span class="i i--default"><svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
          <div>
            <div class="text">Mode Estricte</div>
            <div class="hint">Només usa info del fitxer/context</div>
          </div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="strictMode">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <!-- Recipes Panel (v3.6 - Folder System) -->
    <div id="recipesPanel" class="panel">
      <div class="recipes-panel-content">
        <!-- Search Bar -->
        <div class="recipes-search-wrapper">
          <span class="recipes-search-icon"><span class="i i--sm i--default"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span></span>
          <input type="text" class="recipes-search" id="recipesSearch" placeholder="Cerca receptes..." oninput="filterRecipes()">
        </div>

        <!-- Folders Container -->
        <div id="recipesContainer" class="folders-container">
          <!-- Dynamic folders will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="recipesEmptyState" class="recipes-empty hidden">
          <div class="recipes-empty-icon"><span class="i i--xl i--accent"><svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></span></div>
          <div class="recipes-empty-title">No tens cap carpeta</div>
          <div class="recipes-empty-subtitle">Crea una carpeta per organitzar les teves receptes</div>
          <button class="btn btn-primary" onclick="showNewFolderModal()">+ Nova Carpeta</button>
        </div>

        <!-- No Results State -->
        <div id="recipesNoResults" class="recipes-no-results hidden">
          <div class="recipes-no-results-icon"><span class="i i--xl i--accent"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span></div>
          <div>Cap recepta coincideix amb la cerca</div>
        </div>

        <!-- Floating Add Button -->
        <button class="recipes-fab" onclick="showNewFolderModal()" title="Nova carpeta">+</button>
      </div>
    </div>

    <!-- New Folder Modal (v3.6) -->
    <div id="newFolderModal" class="modal hidden">
      <div class="modal-backdrop" onclick="hideNewFolderModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <span class="modal-title"><span class="i i--accent"><svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></span> Nova Carpeta</span>
          <button class="modal-close" onclick="hideNewFolderModal()"><span class="i"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Icona</label>
            <div class="icon-selector" id="folderIconSelector">
              <!-- Icons rendered by JS -->
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Nom</label>
            <input type="text" class="form-input" id="newFolderName" placeholder="Ex: Les meves receptes" maxlength="30">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="hideNewFolderModal()">Cancel·lar</button>
          <button class="btn btn-primary" onclick="saveNewFolder()">Crear Carpeta</button>
        </div>
      </div>
    </div>

    <!-- New Recipe Modal (v3.6 - Folder System) -->
    <div id="newRecipeModal" class="modal hidden">
      <div class="modal-backdrop" onclick="hideNewRecipeModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <span class="modal-title"><span class="i i--accent"><svg viewBox="0 0 24 24"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h.01"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg></span> Nova Recepta</span>
          <button class="modal-close" onclick="hideNewRecipeModal()"><span class="i"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Icona</label>
            <div class="icon-selector" id="recipeIconSelector">
              <!-- Icons rendered by JS -->
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Nom</label>
            <input type="text" class="form-input" id="newRecipeName" placeholder="Ex: Fer més formal" maxlength="30">
          </div>
          <div class="form-group">
            <label class="form-label">Instrucció per la IA</label>
            <textarea class="form-input" id="newRecipeInstruction" placeholder="Què vols que faci la IA amb el text?" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="hideNewRecipeModal()">Cancel·lar</button>
          <button class="btn btn-primary" onclick="saveNewRecipe()">Crear Recepta</button>
        </div>
      </div>
    </div>

    <!-- Timeline Panel (v4.0 - Forensic Timeline) -->
    <div id="timelinePanel" class="panel">
      <div class="timeline-header">
        <div class="timeline-title">
          <span class="i i--accent"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
          <span>Timeline d'Edicions</span>
        </div>
        <button class="btn btn-sm" onclick="loadTimeline()" title="Actualitzar">
          <span class="i i--sm"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></span>
        </button>
      </div>
      <div class="timeline-content" id="timelineContent">
        <div class="timeline-empty">
          <span class="i i--muted"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
          <span>No hi ha edicions registrades</span>
          <span class="timeline-empty-hint">Les edicions apareixeran aquí automàticament</span>
        </div>
      </div>
    </div>

    <!-- Brain Panel (Settings) -->
    <div id="brainPanel" class="panel">
      <!-- Credits Widget v5.1 -->
      <div class="settings-card credits-card" id="creditsCard">
        <div class="credits-widget">
          <div class="credits-info">
            <span class="i i--accent"><svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span>
            <div class="credits-text">
              <div class="credits-label">Crèdits disponibles</div>
              <div class="credits-value" id="creditsValue">--/--</div>
            </div>
          </div>
          <div class="credits-bar">
            <div class="credits-bar-fill" id="creditsBarFill" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-header">
          <span class="i i--accent"><svg viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg></span>
          <div>
            <div class="title">Llicencia API</div>
            <div class="subtitle">La teva clau d'accés a Docmile</div>
          </div>
        </div>
        <input type="text" class="form-input" id="licenseKey" placeholder="DOCMILE-XXXX-XXXX">
      </div>

      <div class="settings-card">
        <div class="settings-card-header">
          <span class="i i--accent"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></span>
          <div>
            <div class="title">Guia d'Estil</div>
            <div class="subtitle">Personalitza com escriu la IA</div>
          </div>
        </div>
        <textarea class="form-input" id="styleGuide" rows="3" placeholder="Ex: Sigues formal, utilitza catala correcte..."></textarea>
      </div>

      <!-- Edit History Section (v3.0 - Moved from Tools) -->
      <div class="settings-card">
        <div class="settings-card-header">
          <span class="i i--accent"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
          <div>
            <div class="title">Historial d'Edicions</div>
            <div class="subtitle" id="historyStatus">Carregant...</div>
          </div>
        </div>
        <div id="historyList" class="history-list">
          <!-- Dynamic history content -->
        </div>
        <div style="margin-top: var(--space-sm); display: flex; gap: var(--space-sm);">
          <button class="btn btn-secondary btn-sm" onclick="refreshHistory()" style="flex: 1;">
            <span class="i i--default i--sm"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></span> Actualitzar
          </button>
        </div>
      </div>

      <div class="toggle-row">
        <div class="toggle-label">
          <span class="i i--default"><svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></span>
          <div>
            <div class="text">Mode Fosc</div>
            <div class="hint">Canvia l'aparença de la barra lateral</div>
          </div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="darkMode" onchange="toggleTheme()">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="settings-card">
        <div class="settings-card-header">
          <span class="i i--error"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></span>
          <div>
            <div class="title">Paraules Prohibides</div>
            <div class="subtitle">La IA mai usara aquestes paraules</div>
          </div>
        </div>
        <div class="banned-words-list" id="bannedWordsList">
          <div class="banned-words-empty">Cap paraula prohibida</div>
        </div>
        <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm);">
          <input type="text" class="form-input" id="newBannedWord" placeholder="Afegir paraula..." style="flex: 1;">
          <button class="btn btn-secondary" onclick="addBannedWord()" style="flex: none; padding: 8px 12px;">+ Afegir</button>
        </div>
      </div>

      <button class="save-btn" id="saveBtn" onclick="saveSettings()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
        Desar Configuracio
      </button>
      <div id="saveStatus" class="save-status">Guardat correctament!</div>
    </div>

    <!-- In-Document Preview Bar - v3.8 -->
    <div id="inDocPreviewBar" class="in-doc-preview-bar hidden">
      <div class="preview-bar-header">
        <div class="preview-bar-status">
          <span class="i i--accent"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
          <span>Preview actiu al document</span>
          <span class="count" id="previewCount">1</span>
        </div>
      </div>
      <div class="preview-bar-hint">
        Mira el document per veure els canvis proposats
        <span class="preview-legend">
          <span class="legend-item delete"><span class="i i--error i--sm"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span> Eliminar</span>
          <span class="legend-item add"><span class="i i--success i--sm"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></span> Afegir</span>
        </span>
      </div>
      <div class="preview-bar-actions">
        <button class="preview-bar-btn commit" onclick="commitInDocPreview()">
          <span class="i i--success i--sm"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></span> Aplicar canvis
        </button>
        <button class="preview-bar-btn cancel" onclick="cancelInDocPreview()">
          <span class="i i--error i--sm"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span> Cancel·lar
        </button>
      </div>
    </div>

    <!-- Input Area (Footer) - v3.2 Redesign -->
    <div id="inputArea" class="input-area">
      <!-- Header: Mode selector + Preview toggle -->
      <div class="input-header">
        <div class="mode-selector" id="modeSelector">
          <button class="mode-btn" onclick="toggleModeDropdown()" type="button">
            <span class="mode-icon" id="modeIcon"><span class="i i--sm"><svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></span></span>
            <span id="modeLabel">Edit</span>
            <svg class="mode-arrow" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div class="mode-dropdown">
            <button class="mode-option selected" data-mode="edit" onclick="selectMode('edit')">
              <span class="i"><svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></span>
              <div class="details">
                <div class="name">Edit</div>
                <div class="desc">La IA interpreta i edita el document</div>
              </div>
            </button>
            <button class="mode-option" data-mode="chat" onclick="selectMode('chat')">
              <span class="i"><svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg></span>
              <div class="details">
                <div class="name">Xat</div>
                <div class="desc">Només conversa, mai edita</div>
              </div>
            </button>
          </div>
        </div>
        <div class="header-toggles">
          <button class="avoid-words-btn" id="avoidWordsBtn" onclick="toggleAvoidWords()" title="Paraules a evitar">
            Avoid words
          </button>
          <label class="switch-container" title="Preview Mode: previsualitza canvis abans d'aplicar">
            <span class="switch-label">Preview</span>
            <div class="switch" id="previewToggle" onclick="togglePreviewMode()">
              <div class="switch-track">
                <div class="switch-thumb"></div>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- v4.0: Banned Words Chips (visible constraints) -->
      <div class="constraints-area hidden" id="constraintsArea">
        <div class="constraints-chips" id="constraintsChips"></div>
        <div class="constraint-input-wrapper" id="constraintInputWrapper">
          <input type="text" class="constraint-input" id="constraintInput" placeholder="Afegir paraula..." onkeydown="handleConstraintInputKey(event)">
          <button class="constraint-input-confirm" onclick="addConstraintFromInput()"><span class="i i--sm"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></span></button>
        </div>
      </div>

      <!-- Input wrapper amb textarea i send button flotant -->
      <div class="input-wrapper">
        <!-- v5.1: Chat attachment badge -->
        <div class="chat-attachment-badge hidden" id="chatAttachmentBadge">
          <span class="i i--sm i--accent"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span>
          <span class="chat-attachment-name" id="chatAttachmentName"></span>
          <button class="chat-attachment-remove" onclick="removeChatAttachment()" title="Treure">×</button>
        </div>
        <div class="input-row">
          <button class="attach-btn" id="attachBtn" onclick="triggerChatAttachment()" title="Adjuntar fitxer">
            <svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
          </button>
          <textarea id="userInput" placeholder="Escriu el teu missatge..." rows="2"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Enviar">
            <svg viewBox="0 0 24 24"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
          </button>
        </div>
        <input type="file" id="chatFileInput" accept=".pdf,.txt,.csv,.md" onchange="handleChatFileSelect()" style="display: none;">
      </div>
    </div>

    <script>
      // ═══════════════════════════════════════════════════════════
      // ICON SYSTEM (v4.1) - SVG Icon Library
      // ═══════════════════════════════════════════════════════════

      const ICONS = {
        // Actions
        ban: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>',
        check: '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
        checkCircle: '<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        x: '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
        xCircle: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
        plus: '<svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
        minus: '<svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></svg>',
        edit: '<svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
        trash: '<svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',

        // Navigation
        chevronDown: '<svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>',
        chevronRight: '<svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>',
        chevronUp: '<svg viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"/></svg>',

        // Content
        file: '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
        fileText: '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
        folder: '<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
        folderOpen: '<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><path d="M2 10h20"/></svg>',
        tag: '<svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>',

        // UI
        search: '<svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
        settings: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
        key: '<svg viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>',
        eye: '<svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
        eyeOff: '<svg viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',

        // Alerts
        alertCircle: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
        alertTriangle: '<svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        info: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',

        // Actions
        play: '<svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
        zap: '<svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
        lightbulb: '<svg viewBox="0 0 24 24"><path d="M9 18h6M10 22h4M12 2a7 7 0 0 0-4 12.9V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.1A7 7 0 0 0 12 2z"/></svg>',
        book: '<svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
        list: '<svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
        layout: '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>',
        messageSquare: '<svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
        send: '<svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',
        undo: '<svg viewBox="0 0 24 24"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>',
        refresh: '<svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
        // Additional icons for recipes and entities
        wand: '<svg viewBox="0 0 24 24"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h.01"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg>',
        star: '<svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        globe: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',
        ruler: '<svg viewBox="0 0 24 24"><path d="M22 8.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2.5"/><path d="M22 15.5V18a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-2.5"/><path d="M6 4v4"/><path d="M10 4v2"/><path d="M14 4v2"/><path d="M18 4v4"/></svg>',
        target: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
        briefcase: '<svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
        clipboard: '<svg viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>',
        rocket: '<svg viewBox="0 0 24 24"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="M12 15l-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/></svg>',
        pin: '<svg viewBox="0 0 24 24"><path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/></svg>',
        circle: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>',
        messageCircle: '<svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>',
        type: '<svg viewBox="0 0 24 24"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',
        minimize: '<svg viewBox="0 0 24 24"><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></svg>',
        maximize: '<svg viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>',
        clock: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        calendar: '<svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
        dollarSign: '<svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
        percent: '<svg viewBox="0 0 24 24"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>',
        hash: '<svg viewBox="0 0 24 24"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>',
        mail: '<svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
        link: '<svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
        loader: '<svg viewBox="0 0 24 24"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>'
      };

      // Helper function to render icons
      function icon(name, className) {
        const svg = ICONS[name] || ICONS.alertCircle;
        const classes = 'i' + (className ? ' ' + className : '');
        return '<span class="' + classes + '">' + svg + '</span>';
      }

      // ═══════════════════════════════════════════════════════════
      // CREDITS WIDGET (v5.1)
      // ═══════════════════════════════════════════════════════════

      let totalCredits = 100; // Default, will be updated from API

      function updateCredits(remaining, total) {
        if (remaining === undefined || remaining === null) return;

        if (total !== undefined && total !== null) {
          totalCredits = total;
        }

        const valueEl = document.getElementById('creditsValue');
        const barFillEl = document.getElementById('creditsBarFill');

        if (valueEl) {
          valueEl.textContent = remaining + '/' + totalCredits;
        }

        if (barFillEl) {
          const percent = Math.max(0, Math.min(100, (remaining / totalCredits) * 100));
          barFillEl.style.width = percent + '%';

          // Add 'low' class if credits are below 20%
          if (percent < 20) {
            barFillEl.classList.add('low');
          } else {
            barFillEl.classList.remove('low');
          }
        }
      }

      function loadCredits() {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.status === 'ok') {
              updateCredits(result.credits_remaining, result.credits_total);
            } else if (result) {
              updateCredits(result.credits_remaining || 0, result.credits_total || 100);
            }
          })
          .withFailureHandler(function(err) {
            // Silent fail - will show --/--
          })
          .getCreditsInfo();
      }

      // ═══════════════════════════════════════════════════════════
      // STATE & INIT
      // ═══════════════════════════════════════════════════════════

      let currentSettings = {};
      let selectedIcon = 'zap';
      let currentTab = 'chat';
      let currentMode = 'edit'; // edit | chat
      let bannedWords = []; // v2.8: Banned expressions
      let pendingUndo = null; // v2.6 Sprint: Snapshot per Optimistic UI Undo
      let pendingPreviewChanges = null; // v3.2: Canvis pendents d'aprovar
      let pendingDocSnapshot = null;    // v3.3: Snapshot per detectar race conditions
      let previewModeEnabled = true;    // v3.2: Toggle per activar/desactivar preview

      // v5.0: Conversations System
      let currentConversationId = null;
      let conversationsList = [];
      let conversationsLoaded = false;

      // v5.2: Debounced save system
      let pendingSaveMessages = [];
      let saveDebounceTimer = null;
      let conversationMessageCount = 0; // Track for auto-title trigger
      const SAVE_DEBOUNCE_MS = 1500; // Save 1.5s after last message

      console.log('[Docmile v5.2] Loaded - Enhanced Conversations System');

      const MODES = {
        edit: { icon: 'edit', label: 'Edit' },
        chat: { icon: 'messageCircle', label: 'Xat' }
      };

      // ═══════════════════════════════════════════════════════════
      // CONVERSATIONS SYSTEM (v5.0)
      // ═══════════════════════════════════════════════════════════

      function openConversationsDrawer() {
        document.getElementById('conversationsDrawer').classList.add('open');
        document.getElementById('drawerBackdrop').classList.add('visible');
        if (!conversationsLoaded) {
          loadConversations();
        }
      }

      function closeConversationsDrawer() {
        document.getElementById('conversationsDrawer').classList.remove('open');
        document.getElementById('drawerBackdrop').classList.remove('visible');
      }

      function loadConversations() {
        const listEl = document.getElementById('conversationsList');
        const emptyEl = document.getElementById('conversationsEmpty');

        // Show loading skeleton
        listEl.innerHTML = `
          <div class="conversation-skeleton">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-lines">
              <div class="skeleton-line"></div>
              <div class="skeleton-line short"></div>
            </div>
          </div>
          <div class="conversation-skeleton">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-lines">
              <div class="skeleton-line"></div>
              <div class="skeleton-line short"></div>
            </div>
          </div>
        `;
        emptyEl.classList.add('hidden');

        const settings = JSON.parse(getSettings() || '{}');
        if (!settings.license_key) {
          listEl.innerHTML = '';
          emptyEl.classList.remove('hidden');
          return;
        }

        google.script.run
          .withSuccessHandler(function(res) {
            conversationsLoaded = true;
            if (res.status === 'ok' && res.conversations && res.conversations.length > 0) {
              conversationsList = res.conversations;
              renderConversationsList(res.conversations);
              emptyEl.classList.add('hidden');
            } else {
              listEl.innerHTML = '';
              emptyEl.classList.remove('hidden');
            }
          })
          .withFailureHandler(function(err) {
            console.error('Error loading conversations:', err);
            listEl.innerHTML = '';
            emptyEl.classList.remove('hidden');
          })
          .callWorker({
            action: 'list_conversations',
            license_key: settings.license_key,
            limit: 50
          });
      }

      function renderConversationsList(conversations) {
        const listEl = document.getElementById('conversationsList');

        // Group by date
        const groups = groupConversationsByDate(conversations);
        let html = '';

        for (const group of groups) {
          html += '<div class="conversation-group">';
          html += '<div class="conversation-group-title">' + group.label + '</div>';

          for (const conv of group.conversations) {
            const isActive = conv.id === currentConversationId ? ' active' : '';
            const pinnedClass = conv.pinned ? ' active' : '';
            const pinnedBadge = conv.pinned ? '<span class="conversation-pinned">' + icon('pin', 'i--sm') + '</span>' : '';

            html += `
              <div class="conversation-item${isActive}" data-id="${conv.id}" onclick="switchConversation('${conv.id}')">
                <div class="conversation-item-icon">
                  ${icon('messageCircle', 'i--sm')}
                </div>
                <div class="conversation-item-content">
                  <div class="conversation-item-title" onclick="editTitleInline('${conv.id}', this, event)" title="Clic per editar">${escapeHtml(conv.title)}</div>
                  <div class="conversation-item-preview">${escapeHtml(conv.preview || '')}</div>
                  <div class="conversation-item-meta">
                    ${pinnedBadge}
                    <span>${conv.message_count} missatges</span>
                  </div>
                </div>
                <div class="conversation-item-actions">
                  <button class="conversation-action-btn pin${pinnedClass}" onclick="togglePin('${conv.id}', event)" title="${conv.pinned ? 'Desfixar' : 'Fixar'}">
                    ${icon('pin', 'i--sm')}
                  </button>
                  <button class="conversation-action-btn delete" onclick="event.stopPropagation(); deleteConversation('${conv.id}')" title="Eliminar">
                    ${icon('trash', 'i--sm')}
                  </button>
                </div>
              </div>
            `;
          }
          html += '</div>';
        }

        listEl.innerHTML = html;
      }

      function groupConversationsByDate(conversations) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

        const groups = {
          today: { label: 'Avui', conversations: [] },
          yesterday: { label: 'Ahir', conversations: [] },
          lastWeek: { label: 'Aquesta setmana', conversations: [] },
          older: { label: 'Més antic', conversations: [] }
        };

        for (const conv of conversations) {
          const date = new Date(conv.updated_at);
          if (date >= today) {
            groups.today.conversations.push(conv);
          } else if (date >= yesterday) {
            groups.yesterday.conversations.push(conv);
          } else if (date >= lastWeek) {
            groups.lastWeek.conversations.push(conv);
          } else {
            groups.older.conversations.push(conv);
          }
        }

        // Return only non-empty groups
        return Object.values(groups).filter(g => g.conversations.length > 0);
      }

      function switchConversation(conversationId) {
        currentConversationId = conversationId;
        closeConversationsDrawer();

        // Clear chat and show loading
        const chatHistory = document.getElementById('chatHistory');
        chatHistory.innerHTML = '<div class="msg system">Carregant conversa...</div>';

        const settings = JSON.parse(getSettings() || '{}');

        google.script.run
          .withSuccessHandler(function(res) {
            if (res.status === 'ok' && res.conversation) {
              loadConversationMessages(res.conversation);
              updateConversationTitle(res.conversation.title);
              // v5.2: Track message count for auto-title
              conversationMessageCount = res.conversation.message_count || 0;
              // Update active state in drawer
              updateActiveConversation(conversationId);
            } else {
              chatHistory.innerHTML = '<div class="msg system">Error carregant la conversa</div>';
            }
          })
          .withFailureHandler(function(err) {
            console.error('Error loading conversation:', err);
            chatHistory.innerHTML = '<div class="msg system">Error: ' + err.message + '</div>';
          })
          .callWorker({
            action: 'get_conversation',
            license_key: settings.license_key,
            conversation_id: conversationId
          });
      }

      function loadConversationMessages(conversation) {
        const chatHistory = document.getElementById('chatHistory');
        chatHistory.innerHTML = '';

        if (conversation.messages && conversation.messages.length > 0) {
          for (const msg of conversation.messages) {
            addBubble(msg.role === 'ai' ? 'ai' : 'user', msg.content, false);
          }
        } else {
          chatHistory.innerHTML = '<div class="msg system">Conversa buida. Escriu un missatge!</div>';
        }
      }

      function updateConversationTitle(title) {
        document.getElementById('chatCurrentTitle').textContent = title || 'Nova conversa';
      }

      function updateActiveConversation(activeId) {
        document.querySelectorAll('.conversation-item').forEach(function(el) {
          if (el.dataset.id === activeId) {
            el.classList.add('active');
          } else {
            el.classList.remove('active');
          }
        });
      }

      function createNewConversation() {
        currentConversationId = null;
        conversationMessageCount = 0; // v5.2: Reset counter
        updateConversationTitle('Nova conversa');
        closeConversationsDrawer();

        // Clear chat
        const chatHistory = document.getElementById('chatHistory');
        chatHistory.innerHTML = '<div class="msg system">Hola! Soc Docmile, el teu assistent d\'escriptura.</div>';

        // Update drawer if open
        updateActiveConversation(null);
      }

      function deleteConversation(conversationId) {
        if (!confirm('Eliminar aquesta conversa?')) return;

        const settings = JSON.parse(getSettings() || '{}');

        google.script.run
          .withSuccessHandler(function(res) {
            if (res.status === 'ok') {
              showToast('Conversa eliminada', 'success');
              // Remove from list
              conversationsList = conversationsList.filter(c => c.id !== conversationId);
              renderConversationsList(conversationsList);
              // If deleted current, start new
              if (currentConversationId === conversationId) {
                createNewConversation();
              }
            }
          })
          .withFailureHandler(function(err) {
            showToast('Error: ' + err.message, 'error');
          })
          .callWorker({
            action: 'delete_conversation',
            license_key: settings.license_key,
            conversation_id: conversationId
          });
      }

      function filterConversations() {
        const searchTerm = document.getElementById('conversationsSearchInput').value.toLowerCase().trim();

        if (!searchTerm) {
          renderConversationsList(conversationsList);
          return;
        }

        const filtered = conversationsList.filter(function(conv) {
          return conv.title.toLowerCase().includes(searchTerm) ||
                 (conv.preview && conv.preview.toLowerCase().includes(searchTerm));
        });

        if (filtered.length > 0) {
          renderConversationsList(filtered);
          document.getElementById('conversationsEmpty').classList.add('hidden');
        } else {
          document.getElementById('conversationsList').innerHTML = `
            <div class="conversations-empty">
              <div class="conversations-empty-icon">${icon('search', 'i--xl i--muted')}</div>
              <div class="conversations-empty-text">Cap resultat per "${escapeHtml(searchTerm)}"</div>
            </div>
          `;
        }
      }

      // ═══════════════════════════════════════════════════════════
      // THEME MANAGEMENT
      // ═══════════════════════════════════════════════════════════

      function initTheme() {
        const savedTheme = localStorage.getItem('docmile-theme');
        const isDark = savedTheme === 'dark';
        applyTheme(isDark);
        document.getElementById('darkMode').checked = isDark;
      }

      function toggleTheme() {
        const isDark = document.getElementById('darkMode').checked;
        applyTheme(isDark);
        localStorage.setItem('docmile-theme', isDark ? 'dark' : 'light');
      }

      function togglePreviewMode() {
        previewModeEnabled = !previewModeEnabled;
        const btn = document.getElementById('previewToggle');
        if (btn) {
          btn.classList.toggle('active', previewModeEnabled);
        }
        localStorage.setItem('docmile-preview', previewModeEnabled ? 'true' : 'false');
        showToast(previewModeEnabled ? 'Preview Mode activat' : 'Canvis directes activats', 'info');
      }

      function initPreviewMode() {
        const saved = localStorage.getItem('docmile-preview');
        // Default is true (preview enabled)
        previewModeEnabled = saved !== 'false';
        const btn = document.getElementById('previewToggle');
        if (btn) {
          btn.classList.toggle('active', previewModeEnabled);
        }
      }

      // ═══════════════════════════════════════════════════════════
      // IN-DOCUMENT PREVIEW (v3.8)
      // ═══════════════════════════════════════════════════════════

      function showInDocPreviewBar(count) {
        const bar = document.getElementById('inDocPreviewBar');
        const countEl = document.getElementById('previewCount');
        if (bar) {
          bar.classList.remove('hidden');
          if (countEl) countEl.textContent = count || 1;
        }
        // Disable input while preview is active
        document.getElementById('userInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
      }

      function hideInDocPreviewBar() {
        const bar = document.getElementById('inDocPreviewBar');
        if (bar) bar.classList.add('hidden');
        // Re-enable input
        document.getElementById('userInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
      }

      function commitInDocPreview() {
        const commitBtn = document.querySelector('.preview-bar-btn.commit');
        const cancelBtn = document.querySelector('.preview-bar-btn.cancel');

        // Disable buttons during operation
        if (commitBtn) {
          commitBtn.disabled = true;
          commitBtn.innerHTML = icon('loader', 'i--default') + ' Aplicant...';
        }
        if (cancelBtn) cancelBtn.disabled = true;

        google.script.run
          .withSuccessHandler(function(result) {
            hideInDocPreviewBar();
            if (result && result.ok) {
              showToast(result.message || 'Canvis aplicats!', 'success');
              addMessage('assistant', icon('checkCircle', 'i--success') + ' S\'han aplicat ' + result.applied + ' canvis al document.');
            } else {
              showToast(result?.message || 'Error aplicant canvis', 'warning');
              addMessage('assistant', icon('alertTriangle', 'i--warning') + ' Error: ' + (result?.message || 'No s\'han pogut aplicar els canvis'));
            }
            // Reset buttons
            if (commitBtn) {
              commitBtn.disabled = false;
              commitBtn.innerHTML = icon('check', 'i--success') + ' Aplicar canvis';
            }
            if (cancelBtn) cancelBtn.disabled = false;
          })
          .withFailureHandler(function(error) {
            hideInDocPreviewBar();
            showToast('Error: ' + error.message, 'error');
            addMessage('assistant', icon('xCircle', 'i--error') + ' Error aplicant canvis: ' + error.message);
            // Reset buttons
            if (commitBtn) {
              commitBtn.disabled = false;
              commitBtn.innerHTML = icon('check', 'i--success') + ' Aplicar canvis';
            }
            if (cancelBtn) cancelBtn.disabled = false;
          })
          .commitInDocumentPreview();
      }

      function cancelInDocPreview() {
        const commitBtn = document.querySelector('.preview-bar-btn.commit');
        const cancelBtn = document.querySelector('.preview-bar-btn.cancel');

        // Disable buttons during operation
        if (cancelBtn) {
          cancelBtn.disabled = true;
          cancelBtn.innerHTML = icon('loader', 'i--default') + ' Cancel·lant...';
        }
        if (commitBtn) commitBtn.disabled = true;

        google.script.run
          .withSuccessHandler(function(result) {
            hideInDocPreviewBar();
            if (result && result.ok) {
              showToast(result.message || 'Canvis cancel·lats', 'undo');
              addMessage('assistant', icon('undo', 'i--default') + ' S\'han cancel·lat ' + result.cancelled + ' canvis. Document restaurat.');
            } else {
              showToast(result?.message || 'Error cancel·lant', 'warning');
            }
            // Reset buttons
            if (commitBtn) commitBtn.disabled = false;
            if (cancelBtn) {
              cancelBtn.disabled = false;
              cancelBtn.innerHTML = icon('x', 'i--error') + ' Cancel·lar';
            }
          })
          .withFailureHandler(function(error) {
            hideInDocPreviewBar();
            showToast('Error: ' + error.message, 'error');
            // Reset buttons
            if (commitBtn) commitBtn.disabled = false;
            if (cancelBtn) {
              cancelBtn.disabled = false;
              cancelBtn.innerHTML = icon('x', 'i--error') + ' Cancel·lar';
            }
          })
          .cancelInDocumentPreview();
      }

      // Check if there's a pending in-doc preview on page load
      function checkPendingInDocPreview() {
        google.script.run
          .withSuccessHandler(function(hasPending) {
            if (hasPending) {
              showInDocPreviewBar(1); // Show bar, count unknown
              addMessage('system', icon('alertTriangle', 'i--warning') + ' Hi ha un preview pendent al document. Aplica o cancel·la els canvis.');
            }
          })
          .withFailureHandler(function(error) {
            console.log('[InDocPreview] Check failed:', error.message);
          })
          .hasPendingInDocPreview();
      }

      function applyTheme(isDark) {
        if (isDark) {
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
        }
      }

      window.onload = function() {
        // Initialize theme
        initTheme();

        // Initialize preview mode (v3.2)
        initPreviewMode();

        // v3.8: Check for pending in-document preview
        checkPendingInDocPreview();

        // v4.0: Initialize ban tooltip (Sprint 2)
        initBanTooltip();

        // Initialize mode selector
        initModeSelector();

        // Position nav pill
        updateNavPill();

        // Load settings
        google.script.run.withSuccessHandler(function(jsonStr) {
          currentSettings = JSON.parse(jsonStr);
          document.getElementById('licenseKey').value = currentSettings.license_key || '';
          document.getElementById('styleGuide').value = currentSettings.style_guide || '';
          document.getElementById('strictMode').checked = currentSettings.strict_mode || false;
          if (!currentSettings.license_key) {
            switchTab('brain');
          } else {
            // v5.1: Load credits if license is configured
            loadCredits();
          }
        }).getSettings();

        // v2.8: Load banned words
        loadBannedWords();

        // v3.4: Load recipes
        loadRecipes();

        // Enter key handler for banned word input
        document.getElementById('newBannedWord').addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            addBannedWord();
          }
        });

        // Load file info
        google.script.run.withSuccessHandler(function(info) {
          if (info.hasFile) showFileStatus(info.name);
        }).getKnowledgeFileInfo();

        // Enter key handler
        document.getElementById('userInput').addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // Auto-resize textarea (v3.2 - expanded limits)
        const userInput = document.getElementById('userInput');
        userInput.addEventListener('input', function() {
          this.style.height = 'auto';
          const newHeight = Math.min(Math.max(this.scrollHeight, 44), 200);
          this.style.height = newHeight + 'px';
        });

        // Ensure minimum height on focus
        userInput.addEventListener('focus', function() {
          if (this.scrollHeight < 44) {
            this.style.height = '44px';
          }
        });

        // v5.2: Capturar selecció del document quan el ratolí entra a l'àrea d'input
        // Això permet detectar seleccions fetes amb el ratolí abans que el focus canviï
        const inputArea = document.getElementById('inputArea');
        inputArea.addEventListener('mouseenter', function() {
          google.script.run.captureCurrentSelection();
        });

        // Select first icon
        selectIcon('zap');
      };

      // ═══════════════════════════════════════════════════════════
      // MODE SELECTOR
      // ═══════════════════════════════════════════════════════════

      function initModeSelector() {
        let savedMode = localStorage.getItem('docmile-mode') || 'edit';
        // Migrar usuaris antics de 'auto' a 'edit'
        if (savedMode === 'auto') savedMode = 'edit';
        selectMode(savedMode, false);

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
          const selector = document.getElementById('modeSelector');
          if (selector && !selector.contains(e.target)) {
            selector.classList.remove('open');
          }
        });
      }

      function toggleModeDropdown() {
        const selector = document.getElementById('modeSelector');
        selector.classList.toggle('open');
      }

      function selectMode(mode, save = true) {
        currentMode = mode;

        // Update button display
        document.getElementById('modeIcon').innerHTML = icon(MODES[mode].icon, 'i--sm');
        document.getElementById('modeLabel').textContent = MODES[mode].label;

        // Update selected state in dropdown
        document.querySelectorAll('.mode-option').forEach(function(opt) {
          opt.classList.remove('selected');
          if (opt.dataset.mode === mode) {
            opt.classList.add('selected');
          }
        });

        // Close dropdown
        document.getElementById('modeSelector').classList.remove('open');

        // Persist
        if (save) {
          localStorage.setItem('docmile-mode', mode);
        }
      }

      function getCurrentMode() {
        return currentMode;
      }

      // ═══════════════════════════════════════════════════════════
      // NAVIGATION
      // ═══════════════════════════════════════════════════════════

      function switchTab(tabName) {
        currentTab = tabName;

        // Update tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

        // Update panels
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(tabName + 'Panel').classList.add('active');

        // Update pill position
        updateNavPill();

        // Show/hide input area (hide for settings/recipes/structure/timeline panels)
        const inputArea = document.getElementById('inputArea');
        if (tabName === 'brain' || tabName === 'docs' || tabName === 'recipes' || tabName === 'structure' || tabName === 'timeline') {
          inputArea.classList.add('hidden');
        } else {
          inputArea.classList.remove('hidden');
        }

        // v3.9: Auto-refresh structure when opening structure panel
        if (tabName === 'structure') {
          if (typeof refreshStructure === 'function') {
            refreshStructure();
          }
        }

        // v3.9: Auto-refresh history when opening brain/settings panel
        if (tabName === 'brain') {
          if (typeof refreshHistory === 'function') {
            refreshHistory();
          }
        }

        // v5.1: Load knowledge library when opening docs panel
        if (tabName === 'docs') {
          if (typeof initKnowledgePanel === 'function') {
            initKnowledgePanel();
          }
        }
      }

      function updateNavPill() {
        const activeTab = document.querySelector('.tab.active');
        const pill = document.getElementById('navPill');
        if (activeTab && pill) {
          // Actualització immediata
          pill.style.width = activeTab.offsetWidth + 'px';
          pill.style.left = activeTab.offsetLeft + 'px';
          // Actualització després de la transició CSS del label (300ms)
          setTimeout(() => {
            pill.style.width = activeTab.offsetWidth + 'px';
            pill.style.left = activeTab.offsetLeft + 'px';
          }, 320);
        }
      }

      // ═══════════════════════════════════════════════════════════
      // CHAT HISTORY (Memory for v2.4)
      // ═══════════════════════════════════════════════════════════

      function getRecentHistory() {
        const messages = document.querySelectorAll('#chatHistory .msg');
        const history = [];

        messages.forEach(function(msg) {
          // Skip system messages, errors, and thinking indicators
          if (msg.classList.contains('system') ||
              msg.classList.contains('error') ||
              msg.classList.contains('thinking')) {
            return;
          }

          if (msg.classList.contains('user')) {
            // Get text - icons render as empty spans so innerText is clean
            let text = msg.innerText.trim();
            history.push({ role: 'user', text: text });
          } else if (msg.classList.contains('ai')) {
            // v3.3: Get text, removing entire edit badge block if present
            let text = msg.innerText.trim();

            // Remove complete badge line (Document modificat + Desfer + Prohibir)
            // Note: Icons render as empty spans, so innerText has just button text
            text = text.replace(/^Document modificat\s*(Desfer)?\s*(Prohibir)?\s*/i, '');

            // Also clean any remaining button artifacts
            text = text.replace(/^Desfer\s*/i, '');
            text = text.replace(/^Prohibir\s*/i, '');

            // Remove leading newlines
            text = text.replace(/^\s*\n+/, '').trim();

            if (text) {
              history.push({ role: 'model', text: text });
            }
          }
        });

        // Return last 12 messages (6 turns) for better context
        return history.slice(-12);
      }

      // ═══════════════════════════════════════════════════════════
      // CHAT
      // ═══════════════════════════════════════════════════════════

      // v3.7: Handler d'èxit per processUserCommand
      function handleSendSuccess(res) {
        hideThinking();
        document.getElementById('sendBtn').disabled = false;

        // v4.0: Handle auto-ban from NL detection (Sprint 3)
        if (res.auto_ban && res.auto_ban.length > 0) {
          processAutoBan(res.auto_ban);
        }

        // v3.2: Handle Preview Mode response
        if (res.status === 'preview' && res.changes && res.changes.length > 0) {
          // DEBUG TEMPORAL: Mostrar info del document
          if (res._debug_doc_chars !== undefined) {
            addBubble('system', icon('file', 'i--accent') + ' Doc: ' + res._debug_doc_chars + ' chars | Preview: "' + (res._debug_doc_preview || '').substring(0, 50) + '..."');
          }
          showPreviewPanel(res.changes, res.ai_response, res.doc_snapshot);
          if (res.credits !== undefined) {
            updateCredits(res.credits);
          }
          return;
        }

        // Handle preview with 0 changes (fallback - IDs didn't match)
        if (res.status === 'preview' && (!res.changes || res.changes.length === 0)) {
          addBubble('ai', res.ai_response + '\n\n' + icon('alertTriangle', 'i--sm i--warning') + ' No s\'han pogut identificar els canvis específics.', true);
          if (res.credits !== undefined) {
            updateCredits(res.credits);
          }
          return;
        }

        // v3.8: Handle In-Document Preview (Track Changes style)
        if (res.status === 'in_doc_preview') {
          const previewCount = res.changes_count || res.preview_info?.count || 1;
          addBubble('ai', res.ai_response + '\n\n' + icon('search', 'i--sm i--accent') + ' **Preview actiu al document** - Mira el document per veure els canvis proposats.', false);
          showInDocPreviewBar(previewCount);
          if (res.credits !== undefined) {
            updateCredits(res.credits);
          }
          return;
        }

        // Handle in_doc_preview with error
        if (res.status === 'in_doc_preview_error') {
          addBubble('ai', res.ai_response + '\n\n' + icon('alertTriangle', 'i--sm i--warning') + ' ' + (res.preview_error || 'Error aplicant preview al document'), true);
          if (res.credits !== undefined) {
            updateCredits(res.credits);
          }
          return;
        }

        // Normal response handling
        addBubble('ai', res.ai_response, res.mode === 'edit', res.last_edit_word);

        // v3.7: Log estadístiques d'edició per debugging
        if (res.edit_stats) {
          console.log('[Edit Stats]', res.edit_stats);
          // Si hi ha problemes, mostrar-ho a la consola
          if (res.edit_stats.skipped > 0 || res.edit_stats.errors > 0) {
            console.warn('[Edit Warning]', {
              skipped: res.edit_stats.skipped,
              errors: res.edit_stats.errors,
              duration: res.edit_stats.duration_ms + 'ms'
            });
          }
        }

        if (res.credits !== undefined) {
          updateCredits(res.credits);
        }
        // v2.6 Sprint: Show undo bar if edit was made
        if (res.mode === 'edit' && res.undo_snapshot) {
          pendingUndo = res.undo_snapshot;
          showUndoBar();
        }
        // v4.0: Confirm hash after successful edit
        if (res.mode === 'edit' && res.event_id) {
          confirmEditHashAsync(res.event_id);
        }
        // v2.5: Check and show structure hint (one-time)
        checkAndShowStructureHint();

        // v5.2: Queue message for debounced save
        queueMessageForSave(lastSentMessage, res.ai_response, res.mode);
      }

      // ═══════════════════════════════════════════════════════════
      // v5.2: DEBOUNCED SAVE SYSTEM
      // ═══════════════════════════════════════════════════════════

      function showSaveIndicator(state) {
        console.log('[v5.2] showSaveIndicator:', state);
        const indicator = document.getElementById('saveIndicator');
        if (!indicator) {
          console.warn('[v5.2] saveIndicator element not found!');
          return;
        }

        indicator.className = 'save-indicator ' + state;
        switch (state) {
          case 'saving':
            indicator.textContent = 'Guardant...';
            break;
          case 'saved':
            indicator.textContent = 'Guardat';
            setTimeout(() => {
              if (indicator.classList.contains('saved')) {
                indicator.textContent = '';
                indicator.className = 'save-indicator';
              }
            }, 2000);
            break;
          case 'error':
            indicator.textContent = 'Error';
            break;
          default:
            indicator.textContent = '';
        }
      }

      function queueMessageForSave(userMessage, aiResponse, mode) {
        console.log('[v5.2] queueMessageForSave called:', { userMessage: userMessage?.substring(0, 50), mode });
        if (!userMessage) return;

        const now = new Date().toISOString();
        pendingSaveMessages.push({
          id: 'msg_' + Date.now() + '_u',
          role: 'user',
          content: userMessage,
          timestamp: now
        });
        pendingSaveMessages.push({
          id: 'msg_' + Date.now() + '_a',
          role: 'ai',
          content: aiResponse,
          timestamp: now,
          metadata: { mode: mode || 'chat' }
        });

        // Clear the stored message
        lastSentMessage = null;

        // Debounce the save
        if (saveDebounceTimer) {
          clearTimeout(saveDebounceTimer);
        }

        showSaveIndicator('saving');

        saveDebounceTimer = setTimeout(() => {
          flushPendingMessages();
        }, SAVE_DEBOUNCE_MS);
      }

      async function flushPendingMessages() {
        console.log('[v5.2] flushPendingMessages, pending:', pendingSaveMessages.length);
        if (pendingSaveMessages.length === 0) return;

        const messagesToSave = [...pendingSaveMessages];
        pendingSaveMessages = [];
        saveDebounceTimer = null;

        try {
          if (!currentConversationId) {
            // Create new conversation with first message as title
            const firstUserMsg = messagesToSave.find(m => m.role === 'user');
            const title = firstUserMsg
              ? (firstUserMsg.content.length > 47
                  ? firstUserMsg.content.substring(0, 47) + '...'
                  : firstUserMsg.content)
              : 'Nova conversa';

            const result = await new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .callWorker({
                  action: 'create_conversation',
                  title: title,
                  messages: messagesToSave
                });
            });

            if (result.conversation_id) {
              currentConversationId = result.conversation_id;
              conversationMessageCount = messagesToSave.length;
              updateConversationTitle(title);

              // Add to local list instead of reloading
              if (conversationsLoaded) {
                const newConv = {
                  id: result.conversation_id,
                  title: title,
                  preview: messagesToSave[0]?.content?.substring(0, 80) || '',
                  message_count: messagesToSave.length,
                  pinned: false,
                  created_at: new Date().toISOString(),
                  updated_at: new Date().toISOString()
                };
                conversationsList.unshift(newConv);
                renderConversationsList(conversationsList);
              }
            }
          } else {
            // Append to existing conversation
            await new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .callWorker({
                  action: 'append_messages',
                  conversation_id: currentConversationId,
                  messages: messagesToSave
                });
            });

            conversationMessageCount += messagesToSave.length;

            // Trigger auto-title after first exchange (4 messages = 2 turns)
            if (conversationMessageCount === 4) {
              triggerAutoTitle();
            }
          }

          showSaveIndicator('saved');

        } catch (e) {
          console.error('[Conversation Save Error]', e);
          showSaveIndicator('error');
          // Re-queue failed messages for retry
          pendingSaveMessages = [...messagesToSave, ...pendingSaveMessages];
        }
      }

      // Save on page unload
      window.addEventListener('beforeunload', function() {
        if (pendingSaveMessages.length > 0) {
          flushPendingMessages();
        }
      });

      // ═══════════════════════════════════════════════════════════
      // v5.2: AUTO-TITLE GENERATION
      // ═══════════════════════════════════════════════════════════

      function triggerAutoTitle() {
        if (!currentConversationId) return;

        google.script.run
          .withSuccessHandler(function(res) {
            if (res.status === 'ok' && res.generated && res.title) {
              updateConversationTitle(res.title);
              // Update in list too
              const conv = conversationsList.find(c => c.id === currentConversationId);
              if (conv) {
                conv.title = res.title;
                renderConversationsList(conversationsList);
              }
            }
          })
          .withFailureHandler(function(err) {
            console.error('[Auto-title Error]', err);
          })
          .callWorker({
            action: 'generate_title',
            conversation_id: currentConversationId
          });
      }

      // ═══════════════════════════════════════════════════════════
      // v5.2: TITLE EDITING
      // ═══════════════════════════════════════════════════════════

      function editCurrentTitle() {
        if (!currentConversationId) return;

        const titleEl = document.getElementById('chatCurrentTitle');
        const currentTitle = titleEl.textContent;

        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentTitle;
        input.className = 'chat-current-title-input';

        input.onblur = function() {
          saveCurrentTitle(input.value);
        };

        input.onkeydown = function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            input.blur();
          } else if (e.key === 'Escape') {
            titleEl.textContent = currentTitle;
            titleEl.style.display = '';
            input.remove();
          }
        };

        titleEl.style.display = 'none';
        titleEl.parentNode.insertBefore(input, titleEl);
        input.focus();
        input.select();
      }

      function saveCurrentTitle(newTitle) {
        const titleEl = document.getElementById('chatCurrentTitle');
        const input = titleEl.parentNode.querySelector('.chat-current-title-input');

        if (!newTitle || !newTitle.trim()) {
          titleEl.style.display = '';
          if (input) input.remove();
          return;
        }

        newTitle = newTitle.trim();

        google.script.run
          .withSuccessHandler(function(res) {
            if (res.status === 'ok') {
              titleEl.textContent = newTitle;
              // Update in list
              const conv = conversationsList.find(c => c.id === currentConversationId);
              if (conv) {
                conv.title = newTitle;
                renderConversationsList(conversationsList);
              }
            }
          })
          .withFailureHandler(function(err) {
            console.error('[Title Save Error]', err);
            showToast('Error guardant títol', 'error');
          })
          .callWorker({
            action: 'update_conversation',
            conversation_id: currentConversationId,
            title: newTitle
          });

        titleEl.textContent = newTitle;
        titleEl.style.display = '';
        if (input) input.remove();
      }

      function editTitleInline(convId, element, event) {
        event.stopPropagation();

        const currentTitle = element.textContent;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentTitle;
        input.className = 'conversation-title-input';

        input.onblur = function() {
          saveTitleInline(convId, input.value, element);
        };

        input.onkeydown = function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            input.blur();
          } else if (e.key === 'Escape') {
            element.textContent = currentTitle;
            element.style.display = '';
            input.remove();
          }
        };

        input.onclick = function(e) {
          e.stopPropagation();
        };

        element.style.display = 'none';
        element.parentNode.insertBefore(input, element);
        input.focus();
        input.select();
      }

      function saveTitleInline(convId, newTitle, element) {
        const input = element.parentNode.querySelector('.conversation-title-input');

        if (!newTitle || !newTitle.trim()) {
          element.style.display = '';
          if (input) input.remove();
          return;
        }

        newTitle = newTitle.trim();

        google.script.run
          .withSuccessHandler(function(res) {
            if (res.status === 'ok') {
              const conv = conversationsList.find(c => c.id === convId);
              if (conv) {
                conv.title = newTitle;
              }
              // Update header if this is current conversation
              if (convId === currentConversationId) {
                updateConversationTitle(newTitle);
              }
            }
          })
          .withFailureHandler(function(err) {
            console.error('[Title Save Error]', err);
          })
          .callWorker({
            action: 'update_conversation',
            conversation_id: convId,
            title: newTitle
          });

        element.textContent = newTitle;
        element.style.display = '';
        if (input) input.remove();
      }

      // ═══════════════════════════════════════════════════════════
      // v5.2: PIN/UNPIN TOGGLE
      // ═══════════════════════════════════════════════════════════

      function togglePin(convId, event) {
        event.stopPropagation();

        const conv = conversationsList.find(c => c.id === convId);
        if (!conv) return;

        const newPinned = !conv.pinned;

        google.script.run
          .withSuccessHandler(function(res) {
            if (res.status === 'ok') {
              conv.pinned = newPinned;
              // Re-sort: pinned first
              conversationsList.sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(b.updated_at) - new Date(a.updated_at);
              });
              renderConversationsList(conversationsList);
              showToast(newPinned ? 'Conversa fixada' : 'Conversa desfixada', 'success');
            }
          })
          .withFailureHandler(function(err) {
            console.error('[Pin Error]', err);
          })
          .callWorker({
            action: 'update_conversation',
            conversation_id: convId,
            pinned: newPinned
          });
      }

      // v3.7: Handler d'error per processUserCommand
      function handleSendFailure(err) {
        hideThinking();
        document.getElementById('sendBtn').disabled = false;
        // Handle expired knowledge file error
        if (err.message && err.message.includes('KNOWLEDGE_FILE_EXPIRED')) {
          addBubble('error', icon('alertTriangle', 'i--sm i--warning') + ' El fitxer de coneixement ha expirat. <button onclick="clearKnowledgeFileAndRetry()" style="margin-left:8px;padding:4px 8px;background:var(--accent);color:white;border:none;border-radius:4px;cursor:pointer;">Esborrar fitxer</button>');
        } else {
          addBubble('error', 'Error: ' + err.message);
        }
      }

      // v5.0: Temp storage for last sent message (for conversation save)
      let lastSentMessage = null;

      function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text) return;

        // v5.0: Store message for later saving to conversation
        lastSentMessage = text;

        // v3.10: Simplificat - només 2 modes (edit/chat), sense classificació
        addBubble('user', text);
        input.value = '';
        input.style.height = 'auto';

        const btn = document.getElementById('sendBtn');
        btn.disabled = true;

        showThinking();

        google.script.run
          .withSuccessHandler(handleSendSuccess)
          .withFailureHandler(handleSendFailure)
          .processUserCommand(text, getRecentHistory(), getCurrentMode(), previewModeEnabled);
      }

      function addBubble(type, text, isEdit, lastEditWord) {
        const container = document.getElementById('chatHistory');
        const bubble = document.createElement('div');
        bubble.className = 'msg ' + type;

        // v3.3: Funció per escapar HTML i permetre salts de línia
        function sanitizeText(t) {
          const div = document.createElement('div');
          div.textContent = t;
          return div.innerHTML.replace(/\n/g, '<br>');
        }

        if (type === 'ai' && isEdit) {
          let badgeHtml = '<div class="edit-badge">Document modificat' +
            '<button class="revert-btn" onclick="revertLastEdit(this)" title="Desfer canvi">' +
            '<svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>Desfer</button>';

          // v2.8: Add "ban word" button if we have a recently changed word
          if (lastEditWord) {
            badgeHtml += '<button class="ban-word-btn" onclick="addToBannedFromChat(\'' +
              lastEditWord.replace(/'/g, "\\'") + '\')" title="No usar mai aquesta paraula">' +
              icon('ban', 'i--error i--sm') + ' Prohibir</button>';
          }

          badgeHtml += '</div>';
          // v3.3: Escapar text per evitar XSS
          bubble.innerHTML = badgeHtml + sanitizeText(text);
        } else if (type === 'error') {
          // v3.3: Errors poden tenir HTML per botons (controlat internament)
          bubble.innerHTML = text;
        } else {
          bubble.innerText = text;
        }

        container.appendChild(bubble);
        container.scrollTop = container.scrollHeight;
      }

      function showThinking() {
        const container = document.getElementById('chatHistory');
        const thinking = document.createElement('div');
        thinking.className = 'msg thinking';
        thinking.id = 'thinkingIndicator';
        thinking.innerHTML = '<div class="thinking-shimmer"></div>';
        container.appendChild(thinking);
        container.scrollTop = container.scrollHeight;
      }

      function hideThinking() {
        const indicator = document.getElementById('thinkingIndicator');
        if (indicator) indicator.remove();
      }

      // ═══════════════════════════════════════════════════════════
      // OPTIMISTIC UI UNDO (v2.6 Sprint)
      // ═══════════════════════════════════════════════════════════

      function showUndoBar() {
        // Remove existing undo bar if any
        hideUndoBar();

        const container = document.getElementById('chatHistory');
        const undoBar = document.createElement('div');
        undoBar.className = 'undo-bar';
        undoBar.id = 'undoBar';
        undoBar.innerHTML = `
          <div class="undo-bar-text">
            <span class="i i--sm i--warning"><svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span>
            <span>Canvi aplicat</span>
          </div>
          <div class="undo-bar-actions">
            <button class="btn-icon confirm" onclick="commitChange()"><span class="i i--sm"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></span> Acceptar</button>
            <button class="btn-icon undo" onclick="triggerUndo()"><span class="i i--sm"><svg viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></span> Desfer</button>
          </div>
        `;
        container.appendChild(undoBar);
        container.scrollTop = container.scrollHeight;
      }

      function hideUndoBar() {
        const existing = document.getElementById('undoBar');
        if (existing) existing.remove();
      }

      function commitChange() {
        // L'usuari accepta el canvi - simplement amaguem la barra
        pendingUndo = null;
        hideUndoBar();
        addBubble('system', icon('check', 'i--sm i--success') + ' Canvi confirmat');
      }

      function triggerUndo() {
        if (!pendingUndo) {
          addBubble('error', 'No hi ha cap canvi per desfer');
          hideUndoBar();
          return;
        }

        // Bloquejar la UI
        const undoBar = document.getElementById('undoBar');
        if (undoBar) {
          undoBar.classList.add('restoring');
          const textEl = undoBar.querySelector('.undo-bar-text span:last-child');
          if (textEl) textEl.textContent = 'Restaurant';
        }

        google.script.run
          .withSuccessHandler(function(res) {
            hideUndoBar();
            if (res.status === 'restored') {
              pendingUndo = null;
              addBubble('system', icon('undo', 'i--sm i--accent') + ' Text original restaurat');
            } else {
              addBubble('error', 'Error: ' + (res.error || 'No s\'ha pogut restaurar'));
            }
          })
          .withFailureHandler(function(err) {
            hideUndoBar();
            addBubble('error', 'Error: ' + err.message);
          })
          .restoreText(pendingUndo.targetId, pendingUndo.originalText);
      }

      // ═══════════════════════════════════════════════════════════
      // RECEIPTS
      // ═══════════════════════════════════════════════════════════

      function loadReceipts() {
        const container = document.getElementById('receiptsList');
        container.innerHTML = '<div class="loading-text">Carregant receptes...</div>';

        google.script.run
          .withSuccessHandler(function(result) {
            container.innerHTML = '';
            if (result.receipts && result.receipts.length > 0) {
              result.receipts.forEach(function(r, index) {
                const card = document.createElement('div');
                card.className = 'receipt-card';
                card.style.animationDelay = (index * 50) + 'ms';
                const recipeIconName = mapEmojiToIcon(r.icon || r.emoji || 'zap');
                card.innerHTML = `
                  <span class="i i--accent">${ICONS[recipeIconName] || ICONS.circle}</span>
                  <span class="label">${r.label}</span>
                  <button class="delete-btn" onclick="event.stopPropagation(); deleteReceipt('${r.id}')"><span class="i i--sm"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button>
                `;
                card.onclick = function() { runReceipt(r.instruction, r.label); };
                container.appendChild(card);
              });
            } else {
              container.innerHTML = '<div class="empty-state">Cap recepta encara.<br>Crea la primera!</div>';
            }
          })
          .withFailureHandler(function(err) {
            container.innerHTML = '<div class="empty-state" style="color: var(--error);">Error carregant receptes</div>';
          })
          .getReceiptsFromWorker();
      }

      function toggleNewReceiptForm() {
        const form = document.getElementById('newReceiptForm');
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
          document.getElementById('receiptLabel').value = '';
          document.getElementById('receiptInstruction').value = '';
          selectIcon('zap');
        }
      }

      function selectIcon(iconName) {
        selectedIcon = iconName;
        document.querySelectorAll('.icon-picker-btn').forEach(function(btn) {
          btn.classList.remove('selected');
          if (btn.dataset.icon === iconName) btn.classList.add('selected');
        });
      }

      function saveNewReceipt() {
        const label = document.getElementById('receiptLabel').value.trim();
        const instruction = document.getElementById('receiptInstruction').value.trim();

        if (!label) return alert('Posa un nom al boto');
        if (!instruction) return alert('Escriu la instruccio per la IA');

        google.script.run
          .withSuccessHandler(function() {
            toggleNewReceiptForm();
            loadReceipts();
          })
          .withFailureHandler(function(err) {
            alert('Error: ' + err.message);
          })
          .saveReceiptToWorker(label, instruction, selectedIcon);
      }

      function deleteReceipt(receiptId) {
        if (!confirm('Eliminar aquesta recepta?')) return;

        google.script.run
          .withSuccessHandler(function() {
            loadReceipts();
          })
          .withFailureHandler(function(err) {
            alert('Error: ' + err.message);
          })
          .deleteReceiptFromWorker(receiptId);
      }

      function runReceipt(instruction, label) {
        switchTab('chat');
        addBubble('user', icon('target', 'i--sm i--accent') + ' ' + label);
        showThinking();

        document.getElementById('sendBtn').disabled = true;

        google.script.run
          .withSuccessHandler(function(res) {
            hideThinking();
            document.getElementById('sendBtn').disabled = false;

            // v3.3: Handle Preview Mode response (same logic as sendMessage)
            if (res.status === 'preview' && res.changes && res.changes.length > 0) {
              showPreviewPanel(res.changes, res.ai_response, res.doc_snapshot);
              if (res.credits !== undefined) {
                updateCredits(res.credits);
              }
              return;
            }

            // Handle preview with 0 changes (fallback)
            if (res.status === 'preview' && (!res.changes || res.changes.length === 0)) {
              addBubble('ai', res.ai_response + '\n\n' + icon('alertTriangle', 'i--sm i--warning') + ' No s\'han pogut identificar els canvis específics.', true);
              if (res.credits !== undefined) {
                updateCredits(res.credits);
              }
              return;
            }

            // Normal response handling
            addBubble('ai', res.ai_response, res.mode === 'edit', res.last_edit_word);
            if (res.credits !== undefined) {
              updateCredits(res.credits);
            }
            // v3.3: Show undo bar if edit was made
            if (res.mode === 'edit' && res.undo_snapshot) {
              pendingUndo = res.undo_snapshot;
              showUndoBar();
            }
            // v4.0: Confirm hash after successful edit
            if (res.mode === 'edit' && res.event_id) {
              confirmEditHashAsync(res.event_id);
            }
          })
          .withFailureHandler(function(err) {
            hideThinking();
            document.getElementById('sendBtn').disabled = false;
            addBubble('error', 'Error: ' + err.message);
          })
          .processUserCommand(instruction, getRecentHistory(), getCurrentMode(), previewModeEnabled);
      }

      // ═══════════════════════════════════════════════════════════
      // TIMELINE (v4.0 - Forensic Timeline)
      // ═══════════════════════════════════════════════════════════

      function loadTimeline() {
        const container = document.getElementById('timelineContent');
        container.innerHTML = '<div class="loading-text">Carregant timeline...</div>';

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.status === 'ok' && result.timeline) {
              renderTimeline(result.timeline);
            } else {
              container.innerHTML = '<div class="timeline-empty"><span class="i i--muted">' + ICONS.clock + '</span><span>No hi ha edicions registrades</span></div>';
            }
          })
          .withFailureHandler(function(err) {
            container.innerHTML = '<div class="timeline-empty" style="color: var(--error);">Error carregant timeline</div>';
          })
          .getDocumentTimeline();
      }

      function renderTimeline(events) {
        const container = document.getElementById('timelineContent');
        container.innerHTML = '';

        if (!events || events.length === 0) {
          container.innerHTML = '<div class="timeline-empty"><span class="i i--muted">' + ICONS.clock + '</span><span>No hi ha edicions registrades</span></div>';
          return;
        }

        events.forEach(function(event, index) {
          const card = document.createElement('div');
          card.className = 'timeline-card ' + (event.source === 'manual' ? 'timeline-manual' : 'timeline-ai');
          card.style.animationDelay = (index * 30) + 'ms';

          // Determine icon and label based on source/type
          let iconName = 'edit';
          let sourceLabel = 'IA';
          if (event.source === 'manual' || event.operation === 'manual_gap') {
            iconName = 'user';
            sourceLabel = 'Manual';
          } else if (event.source === 'baseline') {
            iconName = 'flag';
            sourceLabel = 'Baseline';
          } else if (event.type === 'REVERT') {
            iconName = 'rotateCcw';
            sourceLabel = 'Revert';
          }

          // Format time
          const timeStr = formatTimelineTime(event.created_at);

          // Words changed indicator
          let wordsInfo = '';
          if (event.words_changed !== null && event.words_changed !== undefined) {
            const sign = event.words_changed >= 0 ? '+' : '';
            const color = event.words_changed >= 0 ? 'var(--success)' : 'var(--error)';
            wordsInfo = '<span class="timeline-words" style="color: ' + color + '">' + sign + event.words_changed + ' paraules</span>';
          }

          // Can revert? Only AI edits that aren't already reverted
          const canRevert = event.source === 'ai' && !event.reverted_at && event.type !== 'REVERT' && event.type !== 'baseline';

          card.innerHTML =
            '<div class="timeline-card-header">' +
              '<span class="timeline-source ' + (event.source === 'manual' ? 'source-manual' : 'source-ai') + '">' +
                '<span class="i i--xs">' + (ICONS[iconName] || ICONS.circle) + '</span> ' + sourceLabel +
              '</span>' +
              '<span class="timeline-time">' + timeStr + '</span>' +
            '</div>' +
            '<div class="timeline-card-body">' +
              (event.instruction ? '<div class="timeline-instruction">' + escapeHtml(event.instruction.substring(0, 100)) + (event.instruction.length > 100 ? '...' : '') + '</div>' : '') +
              (event.thought ? '<div class="timeline-thought">' + escapeHtml(event.thought.substring(0, 80)) + '</div>' : '') +
              wordsInfo +
            '</div>' +
            (event.reverted_at ? '<div class="timeline-reverted">' + ICONS.rotateCcw + ' Revertit</div>' : '') +
            // Expandable details section (hidden by default)
            '<div class="timeline-details hidden">' +
              (event.before_text ? '<div class="timeline-diff"><span class="diff-label">Abans:</span><div class="diff-text diff-before">' + escapeHtml(event.before_text || '').substring(0, 200) + '</div></div>' : '') +
              (event.after_text ? '<div class="timeline-diff"><span class="diff-label">Després:</span><div class="diff-text diff-after">' + escapeHtml(event.after_text || '').substring(0, 200) + '</div></div>' : '') +
              (canRevert ? '<button class="btn btn-sm timeline-revert-btn" onclick="event.stopPropagation(); revertTimelineEvent(\'' + event.id + '\')"><span class="i i--xs">' + ICONS.rotateCcw + '</span> Revertir</button>' : '') +
            '</div>';

          // Click to expand/collapse details
          card.onclick = function() {
            const details = card.querySelector('.timeline-details');
            const isExpanded = card.classList.contains('expanded');

            // Collapse all other cards
            document.querySelectorAll('.timeline-card.expanded').forEach(function(c) {
              c.classList.remove('expanded');
              c.querySelector('.timeline-details').classList.add('hidden');
            });

            // Toggle this card
            if (!isExpanded) {
              card.classList.add('expanded');
              details.classList.remove('hidden');
            }
          };

          container.appendChild(card);
        });
      }

      /**
       * Revert a timeline event
       */
      function revertTimelineEvent(eventId) {
        if (!confirm('Vols revertir aquesta edició?')) return;

        showToast('Revertint...', 'info');

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.status === 'ok' && result.restore_text !== undefined) {
              showToast('Edició revertida!', 'success');
              loadTimeline(); // Refresh timeline
            } else {
              showToast('Error: ' + (result.error || 'No s\'ha pogut revertir'), 'error');
            }
          })
          .withFailureHandler(function(err) {
            showToast('Error: ' + err.message, 'error');
          })
          .revertEditEvent(eventId);
      }

      function formatTimelineTime(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Ara';
        if (diffMins < 60) return 'Fa ' + diffMins + ' min';
        if (diffHours < 24) return 'Fa ' + diffHours + 'h';
        if (diffDays < 7) return 'Fa ' + diffDays + ' dies';

        return date.toLocaleDateString('ca-ES', { day: 'numeric', month: 'short' });
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      /**
       * v4.0: Confirms an edit hash asynchronously (fire-and-forget)
       * Called after a successful edit to close the hash confirmation loop
       */
      function confirmEditHashAsync(eventId) {
        if (!eventId) return;
        // Fire-and-forget: no need to wait for response
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.confirmed) {
              console.log('[Timeline] Hash confirmed for event:', eventId);
            }
          })
          .withFailureHandler(function(err) {
            console.warn('[Timeline] Hash confirmation failed:', err.message);
          })
          .confirmEditHash(eventId);
      }

      // ═══════════════════════════════════════════════════════════
      // RECIPES MANAGEMENT (v3.6 - Folder System)
      // ═══════════════════════════════════════════════════════════

      // Default folders with recipes
      const DEFAULT_FOLDERS = [
        {
          id: 'redaccio',
          name: 'Redacció',
          icon: 'fileText',
          collapsed: false,
          recipes: [
            { id: 'r1', name: 'Corregir', icon: 'edit', instruction: 'Corregeix tots els errors ortogràfics i gramaticals del text' },
            { id: 'r2', name: 'Formal', icon: 'briefcase', instruction: 'Transforma el text a un to més formal i professional' },
            { id: 'r3', name: 'Informal', icon: 'messageCircle', instruction: 'Fes el text més informal, proper i conversacional' },
            { id: 'r4', name: 'Millorar', icon: 'wand', instruction: 'Millora la redacció general mantenint el significat original' },
            { id: 'r5', name: 'Simplificar', icon: 'type', instruction: 'Simplifica el text per fer-lo més fàcil d\'entendre' }
          ]
        },
        {
          id: 'traduccio',
          name: 'Traducció',
          icon: 'globe',
          collapsed: true,
          recipes: [
            { id: 't1', name: 'Anglès', icon: 'globe', instruction: 'Tradueix tot el text a anglès' },
            { id: 't2', name: 'Castellà', icon: 'globe', instruction: 'Tradueix tot el text a castellà' },
            { id: 't3', name: 'Català', icon: 'globe', instruction: 'Tradueix tot el text a català' },
            { id: 't4', name: 'Francès', icon: 'globe', instruction: 'Tradueix tot el text a francès' }
          ]
        },
        {
          id: 'longitud',
          name: 'Longitud',
          icon: 'ruler',
          collapsed: true,
          recipes: [
            { id: 'l1', name: 'Resumir', icon: 'minimize', instruction: 'Resumeix el text mantenint només les idees principals' },
            { id: 'l2', name: 'Ampliar', icon: 'maximize', instruction: 'Amplia i desenvolupa el text amb més detalls i exemples' },
            { id: 'l3', name: 'Concís', icon: 'target', instruction: 'Elimina redundàncies i fes el text més directe' }
          ]
        },
        {
          id: 'estil',
          name: 'Estil',
          icon: 'wand',
          collapsed: true,
          recipes: [
            { id: 's1', name: 'Persuasiu', icon: 'zap', instruction: 'Fes el text més persuasiu i convincent' },
            { id: 's2', name: 'Creatiu', icon: 'star', instruction: 'Afegeix creativitat i originalitat al text' },
            { id: 's3', name: 'Tècnic', icon: 'settings', instruction: 'Transforma a un estil més tècnic i precís' },
            { id: 's4', name: 'Bullets', icon: 'list', instruction: 'Organitza el contingut en llistes amb bullets' }
          ]
        }
      ];

      let userFolders = [];
      let currentSearch = '';
      let selectedFolderId = null;

      // Load folders from backend
      function loadRecipes() {
        google.script.run
          .withSuccessHandler(function(data) {
            if (data && data.length > 0 && data[0].recipes) {
              // Already folder format - filter out "Importades" if exists
              userFolders = data.filter(function(f) {
                return !f.id.startsWith('imported_') && f.name !== 'Importades';
              });
              if (userFolders.length !== data.length) {
                saveRecipes(); // Save without Importades
              }
            } else {
              // First time or old format: load defaults
              userFolders = JSON.parse(JSON.stringify(DEFAULT_FOLDERS));
              saveRecipes();
            }
            renderFolders();
          })
          .withFailureHandler(function(err) {
            console.error('Error loading recipes:', err);
            userFolders = JSON.parse(JSON.stringify(DEFAULT_FOLDERS));
            renderFolders();
          })
          .getRecipes();
      }

      // Save folders to backend
      function saveRecipes() {
        google.script.run
          .withFailureHandler(function(err) {
            console.error('Error saving recipes:', err);
          })
          .saveRecipes(userFolders);
      }

      // Filter recipes by search
      function filterRecipes() {
        currentSearch = document.getElementById('recipesSearch').value.toLowerCase();
        renderFolders();
      }

      // Toggle folder collapsed state
      function toggleFolder(folderId) {
        const folder = userFolders.find(f => f.id === folderId);
        if (folder) {
          folder.collapsed = !folder.collapsed;
          saveRecipes();
          renderFolders();
        }
      }

      // Render folders
      function renderFolders() {
        const container = document.getElementById('recipesContainer');
        const emptyState = document.getElementById('recipesEmptyState');
        const noResults = document.getElementById('recipesNoResults');

        if (userFolders.length === 0) {
          container.innerHTML = '';
          emptyState.classList.remove('hidden');
          if (noResults) noResults.classList.add('hidden');
          return;
        }

        emptyState.classList.add('hidden');

        // Check if any recipes match search
        let hasResults = false;
        if (currentSearch) {
          userFolders.forEach(function(folder) {
            folder.recipes.forEach(function(recipe) {
              if (recipe.name.toLowerCase().includes(currentSearch) ||
                  recipe.instruction.toLowerCase().includes(currentSearch)) {
                hasResults = true;
              }
            });
          });
          if (!hasResults) {
            container.innerHTML = '';
            if (noResults) noResults.classList.remove('hidden');
            return;
          }
        }

        if (noResults) noResults.classList.add('hidden');

        let html = '';
        userFolders.forEach(function(folder, folderIndex) {
          const isCollapsed = folder.collapsed && !currentSearch;
          const toggleIcon = isCollapsed ? '▶' : '▼';

          // Filter recipes if searching
          let recipes = folder.recipes;
          if (currentSearch) {
            recipes = folder.recipes.filter(function(r) {
              return r.name.toLowerCase().includes(currentSearch) ||
                     r.instruction.toLowerCase().includes(currentSearch);
            });
            if (recipes.length === 0) return; // Skip empty folders in search
          }

          // Get folder icon (backwards compatible with emojis)
          const folderIconName = mapEmojiToIcon(folder.icon);
          html += '<div class="folder' + (isCollapsed ? ' collapsed' : '') + '" data-folder-id="' + folder.id + '">' +
            '<div class="folder-header" onclick="toggleFolder(\'' + folder.id + '\')">' +
              '<span class="folder-icon">' + icon(folderIconName, 'i--accent') + '</span>' +
              '<span class="folder-name">' + folder.name + '</span>' +
              '<span class="folder-count">' + folder.recipes.length + '</span>' +
              '<span class="folder-toggle">' + (isCollapsed ? icon('chevronRight', 'i--sm') : icon('chevronDown', 'i--sm')) + '</span>' +
              '<div class="folder-actions">' +
                '<button class="folder-action-btn folder-add-btn" onclick="event.stopPropagation(); showAddRecipeToFolder(\'' + folder.id + '\')" title="Afegir recepta">' + icon('plus', 'i--sm') + '</button>' +
                '<button class="folder-action-btn folder-delete-btn" onclick="event.stopPropagation(); deleteFolder(' + folderIndex + ')" title="Esborrar carpeta">' + icon('trash', 'i--error i--sm') + '</button>' +
              '</div>' +
            '</div>' +
            '<div class="folder-content">';

          recipes.forEach(function(recipe, recipeIndex) {
            const realRecipeIndex = folder.recipes.indexOf(recipe);
            const escapedInstruction = recipe.instruction.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const escapedName = recipe.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            // Get recipe icon (backwards compatible with emojis)
            const recipeIconName = mapEmojiToIcon(recipe.icon || recipe.emoji || 'circle');

            html += '<div class="folder-recipe" onclick="runRecipe(\'' + escapedInstruction + '\', \'' + escapedName + '\')">' +
              '<span class="folder-recipe-icon">' + icon(recipeIconName, 'i--default') + '</span>' +
              '<span class="folder-recipe-name">' + recipe.name + '</span>' +
              '<button class="folder-recipe-delete" onclick="event.stopPropagation(); deleteRecipeFromFolder(' + folderIndex + ', ' + realRecipeIndex + ')" title="Esborrar">' + icon('x', 'i--sm') + '</button>' +
            '</div>';
          });

          html += '</div></div>';
        });

        // Add "New Folder" button
        html += '<button class="add-folder-btn" onclick="showNewFolderModal()">+ Nova Carpeta</button>';

        container.innerHTML = html;
      }

      // Run a recipe
      function runRecipe(instruction, label) {
        switchTab('chat');
        addBubble('user', icon('clipboard', 'i--accent') + ' ' + label);
        showThinking();

        document.getElementById('sendBtn').disabled = true;

        google.script.run
          .withSuccessHandler(function(res) {
            hideThinking();
            document.getElementById('sendBtn').disabled = false;

            // Handle Preview Mode response
            if (res.status === 'preview' && res.changes && res.changes.length > 0) {
              showPreviewPanel(res.changes, res.ai_response, res.doc_snapshot);
              if (res.credits !== undefined) {
                updateCredits(res.credits);
              }
              return;
            }

            // Handle preview with 0 changes (fallback)
            if (res.status === 'preview' && (!res.changes || res.changes.length === 0)) {
              addBubble('ai', res.ai_response + '\n\n' + icon('alertTriangle', 'i--sm i--warning') + ' No s\'han pogut identificar els canvis específics.', true);
              if (res.credits !== undefined) {
                updateCredits(res.credits);
              }
              return;
            }

            // Normal response handling
            addBubble('ai', res.ai_response, res.mode === 'edit', res.last_edit_word);
            if (res.credits !== undefined) {
              updateCredits(res.credits);
            }
            if (res.mode === 'edit' && res.undo_snapshot) {
              pendingUndo = res.undo_snapshot;
              showUndoBar();
            }
            // v4.0: Confirm hash after successful edit
            if (res.mode === 'edit' && res.event_id) {
              confirmEditHashAsync(res.event_id);
            }
          })
          .withFailureHandler(function(err) {
            hideThinking();
            document.getElementById('sendBtn').disabled = false;
            addBubble('error', 'Error: ' + err.message);
          })
          .processUserCommand(instruction, getRecentHistory(), getCurrentMode(), previewModeEnabled);
      }

      // ═══════════════════════════════════════════════════════════
      // FOLDER MANAGEMENT (v3.6)
      // ═══════════════════════════════════════════════════════════

      // Delete a folder
      function deleteFolder(index) {
        const folder = userFolders[index];
        if (!folder) return;

        const msg = folder.recipes.length > 0
          ? 'Vols esborrar la carpeta "' + folder.name + '" i les seves ' + folder.recipes.length + ' recepta(s)?'
          : 'Vols esborrar la carpeta "' + folder.name + '"?';

        if (confirm(msg)) {
          userFolders.splice(index, 1);
          saveRecipes();
          renderFolders();
        }
      }

      // Delete a recipe from a folder
      function deleteRecipeFromFolder(folderIndex, recipeIndex) {
        if (confirm('Vols esborrar aquesta recepta?')) {
          userFolders[folderIndex].recipes.splice(recipeIndex, 1);
          saveRecipes();
          renderFolders();
        }
      }

      // Show new folder modal
      // Available icons for folders and recipes
      const FOLDER_ICONS = ['folder', 'folderOpen', 'fileText', 'globe', 'wand', 'ruler', 'star', 'target', 'briefcase'];
      const RECIPE_ICONS = ['pin', 'edit', 'wand', 'target', 'settings', 'clipboard', 'lightbulb', 'rocket'];

      // Render icon selector buttons
      function renderIconSelector(containerId, icons, selectedIcon, selectFn) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = icons.map(function(iconName) {
          const isSelected = iconName === selectedIcon ? ' selected' : '';
          return '<button type="button" class="icon-picker-btn' + isSelected + '" data-icon="' + iconName + '" onclick="' + selectFn + '(\'' + iconName + '\')">' + icon(iconName, 'i--default') + '</button>';
        }).join('');
      }

      function showNewFolderModal() {
        document.getElementById('newFolderName').value = '';
        selectedFolderIcon = 'folder';
        renderIconSelector('folderIconSelector', FOLDER_ICONS, selectedFolderIcon, 'selectFolderIcon');
        const modal = document.getElementById('newFolderModal');
        modal.classList.remove('hidden');
        setTimeout(function() {
          modal.classList.add('visible');
          document.getElementById('newFolderName').focus();
        }, 10);
      }

      // Hide new folder modal
      function hideNewFolderModal() {
        const modal = document.getElementById('newFolderModal');
        modal.classList.remove('visible');
        setTimeout(function() {
          modal.classList.add('hidden');
        }, 200);
      }

      let selectedFolderIcon = 'folder';
      function selectFolderIcon(iconName) {
        selectedFolderIcon = iconName;
        document.querySelectorAll('#folderIconSelector .icon-picker-btn').forEach(function(btn) {
          btn.classList.toggle('selected', btn.dataset.icon === iconName);
        });
      }

      // Save new folder
      function saveNewFolder() {
        const name = document.getElementById('newFolderName').value.trim();

        if (!name) {
          showToast('Escriu un nom per la carpeta', 'warning');
          return;
        }

        const newFolder = {
          id: 'folder_' + Date.now(),
          name: name,
          icon: selectedFolderIcon,
          collapsed: false,
          recipes: []
        };

        userFolders.push(newFolder);
        saveRecipes();
        renderFolders();
        hideNewFolderModal();
      }

      // Show add recipe to folder modal
      function showAddRecipeToFolder(folderId) {
        selectedFolderId = folderId;
        document.getElementById('newRecipeName').value = '';
        document.getElementById('newRecipeInstruction').value = '';
        selectedRecipeIcon = 'pin';
        renderIconSelector('recipeIconSelector', RECIPE_ICONS, selectedRecipeIcon, 'selectRecipeIcon');
        const modal = document.getElementById('newRecipeModal');
        modal.classList.remove('hidden');
        setTimeout(function() {
          modal.classList.add('visible');
          document.getElementById('newRecipeName').focus();
        }, 10);
      }

      // Hide new recipe modal
      function hideNewRecipeModal() {
        const modal = document.getElementById('newRecipeModal');
        modal.classList.remove('visible');
        setTimeout(function() {
          modal.classList.add('hidden');
        }, 200);
        selectedFolderId = null;
      }

      let selectedRecipeIcon = 'pin';
      function selectRecipeIcon(iconName) {
        selectedRecipeIcon = iconName;
        document.querySelectorAll('#recipeIconSelector .icon-picker-btn').forEach(function(btn) {
          btn.classList.toggle('selected', btn.dataset.icon === iconName);
        });
      }

      // Backwards compatibility: map old emojis to icon names
      function mapEmojiToIcon(emoji) {
        const emojiMap = {
          '📁': 'folder', '📂': 'folderOpen', '📝': 'fileText', '🌍': 'globe',
          '✨': 'wand', '📏': 'ruler', '⭐': 'star', '🎯': 'target', '💼': 'briefcase',
          '📌': 'pin', '✏️': 'edit', '🔧': 'settings', '📋': 'clipboard',
          '💡': 'lightbulb', '🚀': 'rocket', '•': 'circle'
        };
        return emojiMap[emoji] || (ICONS[emoji] ? emoji : 'circle');
      }

      // Save new recipe to folder
      function saveNewRecipe() {
        const name = document.getElementById('newRecipeName').value.trim();
        const instruction = document.getElementById('newRecipeInstruction').value.trim();

        if (!name) {
          showToast('Escriu un nom per la recepta', 'warning');
          return;
        }
        if (!instruction) {
          showToast('Escriu la instrucció per la recepta', 'warning');
          return;
        }

        const folder = userFolders.find(f => f.id === selectedFolderId);
        if (!folder) {
          showToast('Error: Carpeta no trobada', 'error');
          return;
        }

        folder.recipes.push({
          id: 'recipe_' + Date.now(),
          name: name,
          icon: selectedRecipeIcon, // Now uses icon name instead of emoji
          instruction: instruction
        });

        saveRecipes();
        renderFolders();
        hideNewRecipeModal();
      }

      // ═══════════════════════════════════════════════════════════
      // SETTINGS
      // ═══════════════════════════════════════════════════════════

      function saveSettings() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerHTML = '<svg class="spinner" width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.3"/></svg> Desant...';

        const newSettings = {
          license_key: document.getElementById('licenseKey').value,
          style_guide: document.getElementById('styleGuide').value,
          strict_mode: document.getElementById('strictMode').checked
        };

        google.script.run.withSuccessHandler(function() {
          btn.disabled = false;
          btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Desar Configuracio';
          currentSettings = newSettings;

          const status = document.getElementById('saveStatus');
          status.classList.add('visible');
          setTimeout(function() { status.classList.remove('visible'); }, 2000);
        }).saveSettings(JSON.stringify(newSettings));
      }

      // ═══════════════════════════════════════════════════════════
      // KNOWLEDGE LIBRARY (v5.1)
      // ═══════════════════════════════════════════════════════════

      let knowledgeLibrary = [];
      let activeKnowledgeFileId = null;

      function initKnowledgePanel() {
        loadActiveKnowledgeFile();
        refreshKnowledgeLibrary();
      }

      function loadActiveKnowledgeFile() {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.hasFile) {
              activeKnowledgeFileId = result.id;
              showActiveFile(result.name);
              // v5.1: Also show in chat badge
              showChatAttachment(result.name, false);
            } else {
              activeKnowledgeFileId = null;
              hideActiveFile();
              hideChatAttachment();
            }
          })
          .getActiveKnowledgeFile();
      }

      function refreshKnowledgeLibrary() {
        const listEl = document.getElementById('knowledgeLibraryList');
        listEl.innerHTML = '<div class="knowledge-empty"><span>Carregant...</span></div>';

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.files) {
              knowledgeLibrary = result.files;
              renderKnowledgeLibrary();
            }
          })
          .withFailureHandler(function(err) {
            listEl.innerHTML = '<div class="knowledge-empty"><span>Error carregant biblioteca</span></div>';
          })
          .getKnowledgeLibrary();
      }

      function renderKnowledgeLibrary() {
        const listEl = document.getElementById('knowledgeLibraryList');

        if (knowledgeLibrary.length === 0) {
          listEl.innerHTML = `
            <div class="knowledge-empty">
              <span class="i i--muted"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span>
              <span>Cap fitxer a la biblioteca</span>
            </div>
          `;
          return;
        }

        let html = '';
        knowledgeLibrary.forEach(function(file) {
          const isActive = file.id === activeKnowledgeFileId;
          const docsCount = (file.used_in_docs || []).length;
          const sizeKB = Math.round(file.size / 1024);

          html += `
            <div class="knowledge-file-item ${isActive ? 'active' : ''}" onclick="selectKnowledgeFile('${file.id}')">
              <span class="file-icon i i--sm"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span>
              <div class="file-info">
                <div class="file-name">${escapeHtml(file.name)}</div>
                <div class="file-meta">${sizeKB}KB · ${docsCount} doc${docsCount !== 1 ? 's' : ''}</div>
              </div>
              <div class="file-actions">
                <button class="file-action-btn" onclick="event.stopPropagation(); deleteKnowledgeFile('${file.id}')" title="Eliminar">
                  <span class="i i--sm"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></span>
                </button>
              </div>
            </div>
          `;
        });

        listEl.innerHTML = html;
      }

      function selectKnowledgeFile(fileId) {
        if (fileId === activeKnowledgeFileId) {
          // Already active, do nothing
          return;
        }

        showActiveFile('Carregant...', true);

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.status === 'ok') {
              activeKnowledgeFileId = fileId;
              showActiveFile(result.file_name);
              renderKnowledgeLibrary();
            }
          })
          .withFailureHandler(function(err) {
            alert('Error: ' + err.message);
            hideActiveFile();
          })
          .linkKnowledgeFile(fileId);
      }

      function removeActiveFile() {
        google.script.run
          .withSuccessHandler(function() {
            activeKnowledgeFileId = null;
            hideActiveFile();
            renderKnowledgeLibrary();
          })
          .unlinkKnowledgeFile();
      }

      function deleteKnowledgeFile(fileId) {
        if (!confirm('Eliminar aquest fitxer de la biblioteca?')) return;

        google.script.run
          .withSuccessHandler(function() {
            if (fileId === activeKnowledgeFileId) {
              activeKnowledgeFileId = null;
              hideActiveFile();
            }
            refreshKnowledgeLibrary();
          })
          .withFailureHandler(function(err) {
            alert('Error: ' + err.message);
          })
          .deleteFromKnowledgeLibrary(fileId);
      }

      function showActiveFile(name, loading) {
        const displayEl = document.getElementById('activeFileDisplay');
        const nameEl = document.getElementById('activeFileName');
        const statusEl = document.getElementById('activeFileStatus');

        nameEl.textContent = (loading ? '⏳ ' : '📄 ') + name;
        displayEl.classList.remove('hidden');
        statusEl.textContent = loading ? 'Carregant...' : 'Fitxer actiu';
      }

      function hideActiveFile() {
        const displayEl = document.getElementById('activeFileDisplay');
        const statusEl = document.getElementById('activeFileStatus');

        displayEl.classList.add('hidden');
        statusEl.textContent = 'Cap fitxer seleccionat';
      }

      function handleFileSelect() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) return;

        const file = fileInput.files[0];
        if (file.size > 10 * 1024 * 1024) {
          alert('Maxim 10MB');
          return;
        }

        showFileStatus(file.name, true);

        const reader = new FileReader();
        reader.onload = function(e) {
          const base64 = e.target.result.split(',')[1];
          google.script.run
            .withSuccessHandler(function(res) {
              showFileStatus(null);
              if (res && res.status === 'ok' && res.file) {
                activeKnowledgeFileId = res.file.id;
                showActiveFile(res.file.name);
                refreshKnowledgeLibrary();
              }
            })
            .withFailureHandler(function(err) {
              showFileStatus(null);
              alert('Error: ' + err.message);
            })
            .uploadToKnowledgeLibrary(base64, file.type, file.name);
        };
        reader.readAsDataURL(file);
      }

      function showFileStatus(name, uploading) {
        const container = document.getElementById('fileStatusContainer');
        if (!name) {
          container.innerHTML = '';
          return;
        }

        container.innerHTML = `
          <div style="padding: 8px; text-align: center; color: var(--text-muted); font-size: 12px;">
            ⏳ Pujant ${name}...
          </div>
        `;
      }

      // ═══════════════════════════════════════════════════════════
      // CHAT FILE ATTACHMENT (v5.1)
      // ═══════════════════════════════════════════════════════════

      function triggerChatAttachment() {
        document.getElementById('chatFileInput').click();
      }

      function handleChatFileSelect() {
        const fileInput = document.getElementById('chatFileInput');
        if (fileInput.files.length === 0) return;

        const file = fileInput.files[0];
        if (file.size > 10 * 1024 * 1024) {
          alert('Màxim 10MB');
          fileInput.value = '';
          return;
        }

        // Show uploading state
        showChatAttachment(file.name, true);

        const reader = new FileReader();
        reader.onload = function(e) {
          const base64 = e.target.result.split(',')[1];
          google.script.run
            .withSuccessHandler(function(res) {
              if (res && res.status === 'ok' && res.file) {
                activeKnowledgeFileId = res.file.id;
                showChatAttachment(res.file.name, false);
                // Also update Knowledge panel
                showActiveFile(res.file.name);
                refreshKnowledgeLibrary();
              } else {
                hideChatAttachment();
                alert('Error pujant fitxer');
              }
            })
            .withFailureHandler(function(err) {
              hideChatAttachment();
              alert('Error: ' + err.message);
            })
            .uploadToKnowledgeLibrary(base64, file.type, file.name);
        };
        reader.readAsDataURL(file);

        // Reset input so same file can be selected again
        fileInput.value = '';
      }

      function showChatAttachment(name, uploading) {
        const badge = document.getElementById('chatAttachmentBadge');
        const nameEl = document.getElementById('chatAttachmentName');

        nameEl.textContent = uploading ? 'Pujant ' + name + '...' : name;
        badge.classList.remove('hidden');
        badge.classList.toggle('uploading', uploading);
      }

      function hideChatAttachment() {
        const badge = document.getElementById('chatAttachmentBadge');
        badge.classList.add('hidden');
      }

      function removeChatAttachment() {
        hideChatAttachment();
        hideActiveFile();
        activeKnowledgeFileId = null;
        renderKnowledgeLibrary();
        google.script.run.unlinkKnowledgeFile();
      }

      function clearFile() {
        google.script.run.withSuccessHandler(function() {
          hideActiveFile();
        }).clearKnowledgeFile();
      }

      // ═══════════════════════════════════════════════════════════
      // BANNED WORDS (v2.8)
      // ═══════════════════════════════════════════════════════════

      function loadBannedWords() {
        google.script.run
          .withSuccessHandler(function(words) {
            bannedWords = words || [];
            renderBannedWordsList();
            renderConstraintChips(); // v4.0: També renderitza chips
          })
          .withFailureHandler(function(err) {
            console.error('Error loading banned words:', err);
            bannedWords = [];
          })
          .getBannedWords();
      }

      function renderBannedWordsList() {
        const container = document.getElementById('bannedWordsList');
        if (!container) return;

        if (bannedWords.length === 0) {
          container.innerHTML = '<div class="banned-words-empty">Cap paraula prohibida</div>';
          return;
        }

        container.innerHTML = bannedWords.map(function(word, index) {
          return '<span class="banned-word-tag">' +
            '<span>' + escapeHtml(word) + '</span>' +
            '<button class="remove-btn" onclick="removeBannedWord(' + index + ')"><span class="i i--sm"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button>' +
            '</span>';
        }).join('');
      }

      // ═══════════════════════════════════════════════════════════
      // v4.0 SPRINT 1: CONSTRAINT CHIPS (Visible sobre input)
      // ═══════════════════════════════════════════════════════════

      function renderConstraintChips() {
        const container = document.getElementById('constraintsChips');
        const area = document.getElementById('constraintsArea');
        const btn = document.getElementById('avoidWordsBtn');
        if (!container) return;

        if (bannedWords.length === 0) {
          container.innerHTML = '';
          // Hide area if no words
          if (area) area.classList.add('hidden');
          if (btn) btn.classList.remove('active');
          return;
        }

        // Show area if there are words
        if (area) area.classList.remove('hidden');
        if (btn) btn.classList.add('active');

        container.innerHTML = bannedWords.map(function(word, index) {
          return '<span class="constraint-chip">' +
            '<span class="chip-icon">' + icon('ban', 'i--error i--sm') + '</span>' +
            '<span class="chip-text">' + escapeHtml(word) + '</span>' +
            '<button class="chip-remove" onclick="removeConstraintChip(' + index + ')" title="Eliminar restricció">' + icon('x', 'i--sm') + '</button>' +
            '</span>';
        }).join('');
      }

      function removeConstraintChip(index) {
        const removed = bannedWords.splice(index, 1)[0];

        google.script.run
          .withSuccessHandler(function() {
            renderBannedWordsList();
            renderConstraintChips();
            showToast('"' + removed + '" ja es pot usar', 'success');
          })
          .withFailureHandler(function(err) {
            bannedWords.splice(index, 0, removed); // Rollback
            console.error('Error removing constraint:', err);
          })
          .saveBannedWords(bannedWords);
      }

      // v4.0.1: Toggle avoid words area
      function toggleAvoidWords() {
        const area = document.getElementById('constraintsArea');
        const btn = document.getElementById('avoidWordsBtn');
        const input = document.getElementById('constraintInput');

        if (area && btn) {
          const isHidden = area.classList.toggle('hidden');
          btn.classList.toggle('active', !isHidden);

          if (!isHidden && input) {
            input.value = '';
            input.focus();
          }
        }
      }

      function showConstraintInput() {
        const area = document.getElementById('constraintsArea');
        const btn = document.getElementById('avoidWordsBtn');
        const input = document.getElementById('constraintInput');

        if (area) {
          area.classList.remove('hidden');
          if (btn) btn.classList.add('active');
          if (input) {
            input.value = '';
            input.focus();
          }
        }
      }

      function hideConstraintInput() {
        // Keep area visible if there are chips
        const chips = document.querySelectorAll('.constraint-chip');
        if (chips.length === 0) {
          const area = document.getElementById('constraintsArea');
          const btn = document.getElementById('avoidWordsBtn');
          if (area) area.classList.add('hidden');
          if (btn) btn.classList.remove('active');
        }
      }

      function handleConstraintInputKey(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          addConstraintFromInput();
        } else if (event.key === 'Escape') {
          hideConstraintInput();
        }
      }

      function addConstraintFromInput() {
        const input = document.getElementById('constraintInput');
        if (!input) return;

        const word = input.value.trim().toLowerCase();

        if (!word) {
          hideConstraintInput();
          return;
        }

        if (word.length < 2) {
          showToast('Mínim 2 caràcters', 'warning');
          return;
        }

        if (bannedWords.includes(word)) {
          showToast('"' + word + '" ja està prohibida', 'warning');
          hideConstraintInput();
          return;
        }

        bannedWords.push(word);
        hideConstraintInput();

        google.script.run
          .withSuccessHandler(function() {
            renderBannedWordsList();
            renderConstraintChips();
            showToast('"' + word + '" afegit', 'ban');
          })
          .withFailureHandler(function(err) {
            bannedWords.pop(); // Rollback
            showToast('Error afegint paraula', 'error');
          })
          .saveBannedWords(bannedWords);
      }

      // ═══════════════════════════════════════════════════════════
      // v4.0 SPRINT 2: TOOLTIP SELECCIÓ (Ban from chat)
      // ═══════════════════════════════════════════════════════════

      let selectedWordToBan = '';

      function initBanTooltip() {
        const chatHistory = document.getElementById('chatHistory');
        if (!chatHistory) return;

        // Detectar selecció de text al xat
        chatHistory.addEventListener('mouseup', handleTextSelection);
        document.addEventListener('mousedown', hideBanTooltip);
      }

      function handleTextSelection(e) {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();

        // Només mostrar si és una paraula vàlida (1-30 chars, sense espais)
        if (selectedText && selectedText.length >= 2 && selectedText.length <= 30 && !/\s/.test(selectedText)) {
          // Verificar que la selecció és dins d'un missatge de la IA
          const anchorNode = selection.anchorNode;
          if (anchorNode) {
            const msgElement = anchorNode.parentElement.closest('.msg.ai, .msg.assistant');
            if (msgElement) {
              showBanTooltip(selectedText, e.clientX, e.clientY);
              return;
            }
          }
        }
        hideBanTooltip();
      }

      function showBanTooltip(word, x, y) {
        const tooltip = document.getElementById('banTooltip');
        const wordDisplay = document.getElementById('banTooltipWord');

        if (!tooltip || !wordDisplay) return;

        // Ja està prohibida?
        if (bannedWords.includes(word.toLowerCase())) {
          return; // No mostrar tooltip per paraules ja prohibides
        }

        selectedWordToBan = word;
        wordDisplay.textContent = '"' + word + '"';

        // Posicionar tooltip (amb offset per no tapar selecció)
        const offsetX = 10;
        const offsetY = -40;
        tooltip.style.left = Math.min(x + offsetX, window.innerWidth - 180) + 'px';
        tooltip.style.top = Math.max(y + offsetY, 10) + 'px';
        tooltip.classList.add('visible');
      }

      function hideBanTooltip() {
        const tooltip = document.getElementById('banTooltip');
        if (tooltip) {
          tooltip.classList.remove('visible');
        }
        selectedWordToBan = '';
      }

      function banSelectedWord() {
        if (!selectedWordToBan) return;

        const word = selectedWordToBan;
        hideBanTooltip();

        // Afegir a banned words
        if (bannedWords.includes(word.toLowerCase())) {
          showToast('"' + word + '" ja està prohibida', 'warning');
          return;
        }

        bannedWords.push(word.toLowerCase());

        google.script.run
          .withSuccessHandler(function() {
            renderBannedWordsList();
            renderConstraintChips();
            showToast('"' + word + '" afegit - la IA ja no l\'usarà', 'ban');
          })
          .withFailureHandler(function(err) {
            bannedWords.pop(); // Rollback
            showToast('Error afegint paraula', 'error');
          })
          .saveBannedWords(bannedWords);
      }

      // ═══════════════════════════════════════════════════════════
      // v4.0 SPRINT 3: NL AUTO-BAN (Processar paraules detectades)
      // ═══════════════════════════════════════════════════════════

      function processAutoBan(words) {
        if (!words || words.length === 0) return;

        const newWords = [];
        for (const word of words) {
          const lowerWord = word.toLowerCase();
          if (!bannedWords.includes(lowerWord)) {
            bannedWords.push(lowerWord);
            newWords.push(word);
          }
        }

        if (newWords.length === 0) return;

        // Save to backend
        google.script.run
          .withSuccessHandler(function() {
            renderBannedWordsList();
            renderConstraintChips();
            // Show feedback
            if (newWords.length === 1) {
              showToast('"' + newWords[0] + '" afegit automàticament', 'ban');
            } else {
              showToast(newWords.length + ' paraules afegides automàticament', 'ban');
            }
          })
          .withFailureHandler(function(err) {
            // Rollback
            for (const word of newWords) {
              const idx = bannedWords.indexOf(word.toLowerCase());
              if (idx > -1) bannedWords.splice(idx, 1);
            }
            console.error('Error saving auto-banned words:', err);
          })
          .saveBannedWords(bannedWords);
      }

      // v3.3: escapeHtml definida més avall a la secció Preview Mode

      function addBannedWord() {
        const input = document.getElementById('newBannedWord');
        const word = input.value.trim();

        if (!word) return;
        if (bannedWords.includes(word.toLowerCase())) {
          alert('Aquesta paraula ja esta a la llista.');
          return;
        }

        bannedWords.push(word.toLowerCase());
        input.value = '';

        google.script.run
          .withSuccessHandler(function() {
            renderBannedWordsList();
            showToast('"' + word + '" afegit a prohibides', 'ban');
          })
          .withFailureHandler(function(err) {
            bannedWords.pop(); // Rollback
            showToast('Error: ' + err.message, 'error');
          })
          .saveBannedWords(bannedWords);
      }

      function removeBannedWord(index) {
        const removed = bannedWords.splice(index, 1)[0];

        google.script.run
          .withSuccessHandler(function() {
            renderBannedWordsList();
            showToast('"' + removed + '" eliminat de prohibides', 'success');
          })
          .withFailureHandler(function(err) {
            bannedWords.splice(index, 0, removed); // Rollback
            showToast('Error: ' + err.message, 'error');
          })
          .saveBannedWords(bannedWords);
      }

      function addToBannedFromChat(word) {
        if (!word || bannedWords.includes(word.toLowerCase())) return;

        bannedWords.push(word.toLowerCase());

        google.script.run
          .withSuccessHandler(function() {
            renderBannedWordsList();
            renderConstraintChips(); // Also update chips
            showToast('"' + word + '" afegit a prohibides', 'ban');
          })
          .withFailureHandler(function(err) {
            bannedWords.pop(); // Rollback
            console.error('Error adding banned word:', err);
          })
          .saveBannedWords(bannedWords);
      }

      // ═══════════════════════════════════════════════════════════
      // PREVIEW MODE (v3.2) - Visual Diff Engine
      // ═══════════════════════════════════════════════════════════

      /**
       * Computes HTML diff between two texts using word-level comparison
       * Returns HTML with <del> and <ins> tags
       */
      function computeDiffHtml(original, proposed) {
        if (!original && !proposed) return '';
        if (!original) return '<ins class="diff-ins">' + escapeHtml(proposed) + '</ins>';
        if (!proposed) return '<del class="diff-del">' + escapeHtml(original) + '</del>';

        // Tokenize by words (keeping punctuation attached)
        const originalWords = original.split(/(\s+)/);
        const proposedWords = proposed.split(/(\s+)/);

        // Simple LCS-based diff
        const diff = computeWordDiff(originalWords, proposedWords);
        return renderDiff(diff);
      }

      /**
       * Compute word-level diff using simple comparison
       */
      function computeWordDiff(oldWords, newWords) {
        const result = [];
        let i = 0, j = 0;

        while (i < oldWords.length || j < newWords.length) {
          if (i >= oldWords.length) {
            // Rest of new words are insertions
            result.push({ type: 'ins', text: newWords[j] });
            j++;
          } else if (j >= newWords.length) {
            // Rest of old words are deletions
            result.push({ type: 'del', text: oldWords[i] });
            i++;
          } else if (oldWords[i] === newWords[j]) {
            // Match
            result.push({ type: 'eq', text: oldWords[i] });
            i++;
            j++;
          } else {
            // Look ahead for potential match
            const lookAheadOld = oldWords.slice(i, i + 5).indexOf(newWords[j]);
            const lookAheadNew = newWords.slice(j, j + 5).indexOf(oldWords[i]);

            if (lookAheadOld !== -1 && (lookAheadNew === -1 || lookAheadOld <= lookAheadNew)) {
              // Delete old words until match
              for (let k = 0; k < lookAheadOld; k++) {
                result.push({ type: 'del', text: oldWords[i + k] });
              }
              i += lookAheadOld;
            } else if (lookAheadNew !== -1) {
              // Insert new words until match
              for (let k = 0; k < lookAheadNew; k++) {
                result.push({ type: 'ins', text: newWords[j + k] });
              }
              j += lookAheadNew;
            } else {
              // No match found - treat as replace
              result.push({ type: 'del', text: oldWords[i] });
              result.push({ type: 'ins', text: newWords[j] });
              i++;
              j++;
            }
          }
        }

        return result;
      }

      /**
       * Render diff array to HTML
       */
      function renderDiff(diff) {
        let html = '';
        let currentType = null;
        let buffer = '';

        for (const item of diff) {
          if (item.type !== currentType) {
            // Flush buffer
            if (buffer) {
              if (currentType === 'del') {
                html += '<del class="diff-del">' + escapeHtml(buffer) + '</del>';
              } else if (currentType === 'ins') {
                html += '<ins class="diff-ins">' + escapeHtml(buffer) + '</ins>';
              } else {
                html += escapeHtml(buffer);
              }
              buffer = '';
            }
            currentType = item.type;
          }
          buffer += item.text;
        }

        // Flush remaining buffer
        if (buffer) {
          if (currentType === 'del') {
            html += '<del class="diff-del">' + escapeHtml(buffer) + '</del>';
          } else if (currentType === 'ins') {
            html += '<ins class="diff-ins">' + escapeHtml(buffer) + '</ins>';
          } else {
            html += escapeHtml(buffer);
          }
        }

        return html;
      }

      /**
       * Escape HTML special characters
       */
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      /**
       * Show preview panel with proposed changes
       */
      function showPreviewPanel(changes, aiResponse, docSnapshot) {
        pendingPreviewChanges = changes;
        pendingDocSnapshot = docSnapshot || null; // v3.3: Guardar snapshot

        // Remove existing preview panel
        hidePreviewPanel();

        // Build preview HTML
        let changesHtml = '';
        for (const change of changes) {
          const diffHtml = computeDiffHtml(change.originalText, change.proposedText);
          changesHtml += `
            <div class="preview-change">
              <div class="preview-location">Paràgraf ${parseInt(change.targetId) + 1}</div>
              <div class="preview-diff">${diffHtml}</div>
            </div>
          `;
        }

        const previewPanel = document.createElement('div');
        previewPanel.id = 'previewPanel';
        previewPanel.className = 'preview-panel';
        previewPanel.innerHTML = `
          <div class="preview-header">
            ${icon('eye', 'i--accent')}
            <span>Previsualització de Canvis</span>
          </div>
          <div class="preview-content">
            ${changesHtml}
          </div>
          <div class="preview-actions">
            <button class="btn btn-cancel" onclick="cancelPreview()">
              ${icon('x', 'i--error i--sm')} Cancel·lar
            </button>
            <button class="btn btn-apply" onclick="applyPreviewedChanges()">
              ${icon('check', 'i--success i--sm')} Aplicar
            </button>
          </div>
        `;

        // Add to chat history
        const container = document.getElementById('chatHistory');
        container.appendChild(previewPanel);
        container.scrollTop = container.scrollHeight;

        // Add AI response bubble
        if (aiResponse) {
          addBubble('ai', aiResponse);
        }
      }

      /**
       * Hide preview panel
       */
      function hidePreviewPanel() {
        const existing = document.getElementById('previewPanel');
        if (existing) existing.remove();
      }

      /**
       * Apply the previewed changes
       */
      function applyPreviewedChanges() {
        if (!pendingPreviewChanges || pendingPreviewChanges.length === 0) {
          showToast('No hi ha canvis pendents', 'error');
          return;
        }

        const panel = document.getElementById('previewPanel');
        if (panel) panel.classList.add('applying');

        // v3.3: Timeout de seguretat (15 segons)
        const timeoutId = setTimeout(function() {
          const p = document.getElementById('previewPanel');
          if (p) p.classList.remove('applying');
          addBubble('error', icon('clock', 'i--warning') + ' Timeout: L\'operació ha trigat massa. Torna-ho a provar.');
        }, 15000);

        google.script.run
          .withSuccessHandler(function(res) {
            clearTimeout(timeoutId);
            hidePreviewPanel();
            pendingPreviewChanges = null;
            pendingDocSnapshot = null; // v3.3: Clear snapshot

            if (res.ok) {
              addBubble('system', icon('checkCircle', 'i--success') + ' ' + res.applied + ' canvi(s) aplicat(s)');

              // Show undo bar for reverting
              if (res.undoSnapshots && res.undoSnapshots.length > 0) {
                pendingUndo = res.undoSnapshots[0];
                showUndoBar();
              }
            } else {
              addBubble('error', 'Error: ' + (res.error || 'Error desconegut'));
            }
          })
          .withFailureHandler(function(err) {
            clearTimeout(timeoutId);
            const panel = document.getElementById('previewPanel');
            if (panel) panel.classList.remove('applying');
            addBubble('error', 'Error: ' + err.message);
          })
          .applyPendingChanges(pendingPreviewChanges, pendingDocSnapshot);
      }

      /**
       * Cancel preview and discard changes
       */
      function cancelPreview() {
        pendingPreviewChanges = null;
        pendingDocSnapshot = null; // v3.3: Clear snapshot
        hidePreviewPanel();
        addBubble('system', icon('undo', 'i--default') + ' Canvis descartats');
      }

      function clearKnowledgeFileAndRetry() {
        google.script.run
          .withSuccessHandler(function() {
            showToast('Fitxer esborrat. Torna a enviar el missatge.', 'success');
            updateKnowledgeFileDisplay();
          })
          .withFailureHandler(function(err) {
            showToast('Error: ' + err.message, 'error');
          })
          .clearKnowledgeFile();
      }

      function showToast(message, type) {
        // Create a simple toast notification with icon support
        const toast = document.createElement('div');
        toast.style.cssText = 'position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); ' +
          'background: var(--bg-tertiary); color: var(--text-primary); padding: 8px 16px; ' +
          'border-radius: var(--radius-md); font-size: 12px; box-shadow: var(--shadow-md); ' +
          'z-index: 1000; animation: msgAppear 0.3s ease; display: flex; align-items: center; gap: 6px;';

        // Add icon based on type
        let iconHtml = '';
        if (type === 'success') iconHtml = icon('checkCircle', 'i--success');
        else if (type === 'error') iconHtml = icon('xCircle', 'i--error');
        else if (type === 'warning') iconHtml = icon('alertTriangle', 'i--warning');
        else if (type === 'ban') iconHtml = icon('ban', 'i--error');
        else if (type === 'info') iconHtml = icon('info', 'i--accent');
        else if (type === 'undo') iconHtml = icon('undo', 'i--default');

        toast.innerHTML = iconHtml + '<span>' + message + '</span>';
        document.body.appendChild(toast);

        setTimeout(function() {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s';
          setTimeout(function() { toast.remove(); }, 300);
        }, 2000);
      }

      // ═══════════════════════════════════════════════════════════
      // DOCUMENT SKELETON (v2.9) + CONTEXT HINTS (v2.5)
      // ═══════════════════════════════════════════════════════════

      let currentSkeleton = null;
      const HINT_SHOWN_KEY = 'docmile-structure-hint-shown';

      /**
       * Check and show one-time structure hint in chat (v2.5)
       */
      function checkAndShowStructureHint() {
        // Only show once per session
        if (sessionStorage.getItem(HINT_SHOWN_KEY)) return;

        google.script.run
          .withSuccessHandler(function(summary) {
            if (summary && summary.has_suggestions && summary.visual_headings > 0) {
              // Mark as shown
              sessionStorage.setItem(HINT_SHOWN_KEY, 'true');
              // Show hint in chat
              addBubble('system', icon('lightbulb', 'i--warning') + ' Tip: El document té ' + summary.visual_headings +
                ' títols visuals sense format. Ves a Estructura > Auto-Structure per millorar-lo.');
            }
          })
          .getContextSummary();
      }

      // ═══════════════════════════════════════════════════════════
      // STRUCTURE PANEL (v3.9)
      // ═══════════════════════════════════════════════════════════

      let currentStructure = null;
      let lastScanTime = null;

      function refreshStructure() {
        const statsChars = document.getElementById('statChars');
        const statsParagraphs = document.getElementById('statParagraphs');
        const statsHeadings = document.getElementById('statHeadings');
        const metaEl = document.getElementById('structureMeta');
        const outlineTree = document.getElementById('outlineTree');
        const entitiesGrid = document.getElementById('entitiesGrid');

        // Show loading state
        outlineTree.innerHTML = '<div class="outline-empty"><span class="outline-empty-icon">' + icon('loader', 'i--muted') + '</span><span>Escanejant document...</span></div>';

        google.script.run
          .withSuccessHandler(function(skeleton) {
            currentStructure = skeleton;
            lastScanTime = new Date();

            if (skeleton && skeleton.stats) {
              // Update stats (backend usa total_chars i paragraph_count)
              statsChars.textContent = formatNumber(skeleton.stats.total_chars || skeleton.stats.chars || 0);
              statsParagraphs.textContent = skeleton.stats.paragraph_count || skeleton.stats.paragraphs || 0;

              const headings = skeleton.structure.filter(function(item) {
                return item.type !== 'SECTION' && item.type !== 'WARNING';
              }).length;
              statsHeadings.textContent = headings;

              // Update meta
              metaEl.innerHTML = '<span class="meta-item">Escanejat en ' + skeleton.stats.scan_time_ms + 'ms</span>';

              // Render outline tree
              renderOutlineTree(skeleton);

              // Render entities
              renderEntities(skeleton);

              // Check for suggestions
              checkStructureSuggestions(skeleton);
            } else if (skeleton && skeleton.error) {
              outlineTree.innerHTML = '<div class="outline-empty"><span class="outline-empty-icon">' + icon('alertTriangle', 'i--warning') + '</span><span>' + skeleton.error + '</span></div>';
            } else {
              statsChars.textContent = '0';
              statsParagraphs.textContent = '0';
              statsHeadings.textContent = '0';
              outlineTree.innerHTML = '<div class="outline-empty"><span class="outline-empty-icon">' + icon('file', 'i--muted') + '</span><span>Document buit</span></div>';
            }
          })
          .withFailureHandler(function(err) {
            outlineTree.innerHTML = '<div class="outline-empty"><span class="outline-empty-icon">' + icon('xCircle', 'i--error') + '</span><span>Error: ' + err.message + '</span></div>';
          })
          .getDocSkeleton();
      }

      function formatNumber(num) {
        if (num >= 1000) {
          return (num / 1000).toFixed(1) + 'k';
        }
        return num.toString();
      }

      function renderOutlineTree(skeleton) {
        const outlineTree = document.getElementById('outlineTree');

        if (!skeleton || !skeleton.structure || skeleton.structure.length === 0) {
          outlineTree.innerHTML = '<div class="outline-empty"><span class="outline-empty-icon">' + icon('file', 'i--muted') + '</span><span>Cap estructura detectada</span></div>';
          return;
        }

        let html = '';
        let currentDepth = 0;

        skeleton.structure.forEach(function(item, idx) {
          // Determine depth based on type
          let depth = 0;
          let typeClass = '';
          let typeLabel = '';

          if (item.type === 'HEADING_1' || item.type === 'H1' || item.type === 'TITLE') {
            depth = 0;
            typeClass = 'h1';
            typeLabel = 'Títol';
          } else if (item.type === 'HEADING_2' || item.type === 'H2' || item.type === 'SUBTITLE') {
            depth = 1;
            typeClass = 'h2';
            typeLabel = 'Sec';
          } else if (item.type === 'HEADING_3' || item.type === 'H3') {
            depth = 2;
            typeClass = 'h3';
            typeLabel = 'Sub';
          } else if (item.type === 'HEADING_4' || item.type === 'H4') {
            depth = 3;
            typeClass = 'h4';
            typeLabel = 'Sub';
          } else if (item.type === 'BOLD_HEADER' || item.type === 'BOLD') {
            depth = currentDepth + 1;
            typeClass = 'bold';
            typeLabel = 'Neg';
          } else {
            // Ignorar SECTION i P - només mostrem títols
            return;
          }

          currentDepth = depth;

          // Backend retorna 'text' per headings i 'preview' per seccions
          const textContent = item.text || item.preview || '';
          const preview = textContent.substring(0, 40) + (textContent.length > 40 ? '...' : '') || 'Sense text';
          // Backend retorna 'index', no 'idx'
          const itemIndex = item.index !== undefined ? item.index : idx;

          html += '<div class="outline-item" data-depth="' + depth + '" data-idx="' + itemIndex + '" onclick="scrollToElement(' + itemIndex + ')">';
          html += '<span class="outline-type ' + typeClass + '">' + typeLabel + '</span>';
          html += '<span class="outline-text">' + escapeHtml(preview) + '</span>';
          html += '<span class="outline-id">¶' + itemIndex + '</span>';
          html += '</div>';
        });

        outlineTree.innerHTML = html;
      }

      function renderEntities(skeleton) {
        const entitiesGrid = document.getElementById('entitiesGrid');
        const entitiesSection = document.getElementById('entitiesSection');

        if (!skeleton || !skeleton.entities || Object.keys(skeleton.entities).length === 0) {
          entitiesSection.style.display = 'none';
          return;
        }

        entitiesSection.style.display = 'block';

        const entityIconNames = {
          dates: 'calendar',
          amounts: 'dollarSign',
          percentages: 'percent',
          numbers: 'hash',
          emails: 'mail',
          urls: 'link'
        };

        let html = '';

        for (const [type, items] of Object.entries(skeleton.entities)) {
          if (items && items.length > 0) {
            const iconName = entityIconNames[type] || 'tag';
            html += '<div class="entity-tag">';
            html += '<span class="entity-icon">' + icon(iconName, 'i--accent i--sm') + '</span>';
            html += '<span class="entity-count">' + items.length + '</span>';
            html += '<span>' + type + '</span>';
            html += '</div>';
          }
        }

        entitiesGrid.innerHTML = html || '<span style="color: var(--text-muted); font-size: 11px;">Cap entitat detectada</span>';
      }

      function checkStructureSuggestions(skeleton) {
        const suggestionEl = document.getElementById('structureSuggestion');
        const suggestionText = document.getElementById('suggestionText');

        if (!skeleton || !skeleton.structure) {
          suggestionEl.classList.add('hidden');
          return;
        }

        // Count native vs visual headings
        let nativeHeadings = 0;
        let visualHeadings = 0;

        skeleton.structure.forEach(function(item) {
          if (item.type === 'HEADING_1' || item.type === 'HEADING_2' || item.type === 'HEADING_3') {
            nativeHeadings++;
          } else if (item.type === 'BOLD_HEADER') {
            visualHeadings++;
          }
        });

        // Suggest if there are visual headings but few native ones
        if (visualHeadings > 0 && nativeHeadings < visualHeadings) {
          suggestionText.textContent = 'Hi ha ' + visualHeadings + ' títols visuals que podrien ser headings natius. Usa Auto-Structure per millorar l\'accessibilitat.';
          suggestionEl.classList.remove('hidden');
        } else {
          suggestionEl.classList.add('hidden');
        }
      }

      function applySuggestion() {
        runAutoStructure();
        document.getElementById('structureSuggestion').classList.add('hidden');
      }

      function dismissSuggestion() {
        document.getElementById('structureSuggestion').classList.add('hidden');
      }

      function filterOutline() {
        const searchValue = document.getElementById('structureSearch').value.toLowerCase();
        const items = document.querySelectorAll('.outline-item');

        items.forEach(function(item) {
          const text = item.querySelector('.outline-text').textContent.toLowerCase();
          if (text.includes(searchValue) || searchValue === '') {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
      }

      function scrollToElement(idx) {
        // Highlight UI instantly (before backend call)
        const items = document.querySelectorAll('.outline-item');
        items.forEach(function(item) {
          item.classList.remove('active');
          if (item.dataset.idx == idx) {
            item.classList.add('active');
          }
        });

        // Then scroll in document
        google.script.run.scrollToParagraph(idx);
      }

      // Legacy function alias for compatibility - redirects to new function
      function refreshSkeleton() {
        refreshStructure();
      }

      function renderSkeletonPreview(skeleton) {
        const previewEl = document.getElementById('skeletonPreview');
        const suggestionEl = document.getElementById('skeletonSuggestion');

        if (!skeleton || !skeleton.structure || skeleton.structure.length === 0) {
          previewEl.innerHTML = '<div class="skeleton-item">Cap estructura detectada</div>';
          previewEl.classList.remove('hidden');
          if (suggestionEl) suggestionEl.classList.add('hidden');
          return;
        }

        // Count types for suggestions
        let nativeHeadings = 0;
        let visualHeadings = 0;
        let sections = 0;

        let html = '';
        let currentIndent = 0;

        skeleton.structure.forEach(function(item, idx) {
          if (item.type === 'SECTION') {
            sections++;
            const indentClass = currentIndent > 0 ? ' indent-' + Math.min(currentIndent, 3) : '';
            html += '<div class="skeleton-item section' + indentClass + '">';
            html += '<span class="skeleton-badge section">§</span>';
            html += item.preview.substring(0, 45) + (item.preview.length > 45 ? '...' : '');
            html += '</div>';
            if (item.entities && item.entities.length > 0) {
              html += '<div class="skeleton-entities">└─ ' + item.entities.slice(0, 3).join(', ') + '</div>';
            }
          } else if (item.type === 'WARNING') {
            html += '<div class="skeleton-item" style="color: var(--warning);">' + icon('alertTriangle', 'i--sm i--warning') + ' ' + item.text + '</div>';
          } else {
            // Heading types
            const isVisual = (item.type === 'VISUAL_H' || item.type === 'BOLD_H');
            if (isVisual) {
              visualHeadings++;
            } else {
              nativeHeadings++;
            }

            // Calculate indent based on heading level
            if (item.type === 'H1' || item.type === 'TITLE') currentIndent = 1;
            else if (item.type === 'H2' || item.type === 'SUBTITLE') currentIndent = 2;
            else if (item.type === 'H3') currentIndent = 3;
            else if (isVisual) currentIndent = Math.min(currentIndent + 1, 3);

            const indentClass = currentIndent > 1 ? ' indent-' + (currentIndent - 1) : '';
            const badgeClass = isVisual ? 'visual' : 'heading';
            const itemIcon = isVisual ? icon('zap', 'i--sm i--warning') : icon('pin', 'i--sm i--accent');
            const badgeText = item.type.replace('_H', '').replace('HEADING', 'H');

            html += '<div class="skeleton-item heading' + indentClass + '">';
            html += '<span class="skeleton-badge ' + badgeClass + '">' + badgeText + '</span>';
            html += itemIcon + ' ' + item.text.substring(0, 40) + (item.text.length > 40 ? '...' : '');
            html += '</div>';
          }
        });

        previewEl.innerHTML = html;
        previewEl.classList.remove('hidden');

        // Show suggestion if visual headings but no native
        if (suggestionEl) {
          if (nativeHeadings === 0 && visualHeadings > 0) {
            suggestionEl.innerHTML =
              '<span class="suggestion-text">' + icon('zap', 'i--sm i--warning') + ' Detectats ' + visualHeadings + ' títols sense format natiu</span>' +
              '<button class="suggestion-btn" onclick="runAutoStructure()">Auto-Structure</button>';
            suggestionEl.classList.remove('hidden');
          } else {
            suggestionEl.classList.add('hidden');
          }
        }
      }

      function runAutoStructure() {
        showToast('Aplicant Auto-Structure...', 'info');

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              if (result.converted > 0) {
                showToast(result.converted + ' títols convertits a H2', 'success');
                // Refresh structure to show new headings
                setTimeout(refreshStructure, 500);
              } else {
                showToast('Cap canvi necessari - estructura correcta', 'info');
              }
            } else {
              showToast('Error: ' + (result ? result.error : 'Unknown'), 'error');
            }
          })
          .withFailureHandler(function(err) {
            showToast('Error: ' + err.message, 'error');
          })
          .applyAutoStructure();
      }

      // ═══════════════════════════════════════════════════════════
      // REVERT LAST EDIT (v2.6)
      // ═══════════════════════════════════════════════════════════

      function revertLastEdit(btn) {
        // Disable button to prevent double-click
        btn.disabled = true;
        btn.innerHTML = '<svg class="spinner" width="10" height="10" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.3"/></svg>';

        google.script.run
          .withSuccessHandler(function(res) {
            if (res.success) {
              // Update the badge to show reverted
              const badge = btn.parentElement;
              badge.innerHTML = '<span style="color: var(--warning);">' + icon('undo', 'i--warning i--sm') + ' Canvi desfet</span>';
              badge.style.background = 'rgba(249, 171, 0, 0.1)';
              badge.style.borderColor = 'var(--warning)';
              badge.style.color = 'var(--warning)';

              // Add system message
              addBubble('system', 'S\'ha desfet l\'últim canvi.');
            } else {
              btn.disabled = false;
              btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>Desfer';
              alert('No s\'ha pogut desfer: ' + (res.error || 'Error desconegut'));
            }
          })
          .withFailureHandler(function(err) {
            btn.disabled = false;
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>Desfer';
            alert('Error: ' + err.message);
          })
          .revertLastEdit();
      }

      // ═══════════════════════════════════════════════════════════
      // EDIT HISTORY (v3.0 Event Sourcing)
      // ═══════════════════════════════════════════════════════════

      let editHistory = [];

      function refreshHistory() {
        const statusEl = document.getElementById('historyStatus');
        const listEl = document.getElementById('historyList');

        statusEl.textContent = 'Carregant...';
        listEl.innerHTML = '<div class="history-empty">Carregant historial...</div>';

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success && result.history) {
              editHistory = result.history;
              const activeCount = editHistory.filter(function(e) { return !e.is_reverted; }).length;
              statusEl.textContent = activeCount + ' edicions actives';
              renderHistoryList();
            } else if (result && result.error) {
              statusEl.textContent = 'Error';
              listEl.innerHTML = '<div class="history-empty" style="color: var(--error);">' + result.error + '</div>';
            } else {
              statusEl.textContent = 'Sense historial';
              listEl.innerHTML = '<div class="history-empty">Cap edició registrada</div>';
            }
          })
          .withFailureHandler(function(err) {
            statusEl.textContent = 'Error';
            listEl.innerHTML = '<div class="history-empty" style="color: var(--error);">Error: ' + err.message + '</div>';
          })
          .getEditHistory(10);
      }

      function renderHistoryList() {
        const listEl = document.getElementById('historyList');

        if (!editHistory || editHistory.length === 0) {
          listEl.innerHTML = '<div class="history-empty">Cap edició registrada</div>';
          return;
        }

        const typeIconNames = {
          'UPDATE_BY_ID': 'edit',
          'REWRITE': 'fileText',
          'REVERT': 'undo',
          'AUTO_STRUCTURE': 'wand'
        };

        const typeLabels = {
          'UPDATE_BY_ID': 'Edit',
          'REWRITE': 'Rewrite',
          'REVERT': 'Revert',
          'AUTO_STRUCTURE': 'Auto'
        };

        let html = '';
        editHistory.forEach(function(event) {
          const iconName = typeIconNames[event.event_type] || 'file';
          const typeLabel = typeLabels[event.event_type] || event.event_type;
          const instruction = event.user_instruction || '(Sense instrucció)';
          const timeAgo = formatTimeAgo(new Date(event.created_at));
          const isReverted = event.is_reverted;

          html += '<div class="history-item' + (isReverted ? ' reverted' : '') + '" data-id="' + event.id + '">';
          html += '<span class="history-icon">' + icon(iconName, 'i--default') + '</span>';
          html += '<div class="content">';
          html += '<div class="instruction" title="' + escapeHtml(instruction) + '">' + escapeHtml(instruction.substring(0, 50)) + (instruction.length > 50 ? '...' : '') + '</div>';
          html += '<div class="meta">';
          html += '<span class="type-badge">' + typeLabel + '</span>';
          html += '<span>' + timeAgo + '</span>';
          if (event.target_id !== null && event.target_id !== undefined) {
            html += '<span>¶' + event.target_id + '</span>';
          }
          html += '</div></div>';

          if (!isReverted && event.event_type !== 'REVERT') {
            html += '<button class="revert-action" onclick="event.stopPropagation(); revertHistoryItem(\'' + event.id + '\')">' + icon('undo', 'i--sm') + ' Desfer</button>';
          }

          html += '</div>';
        });

        listEl.innerHTML = html;
      }

      function formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Ara';
        if (diffMins < 60) return diffMins + ' min';
        if (diffHours < 24) return diffHours + 'h';
        if (diffDays < 7) return diffDays + 'd';
        return date.toLocaleDateString('ca-ES', { day: 'numeric', month: 'short' });
      }

      function revertHistoryItem(eventId) {
        const item = document.querySelector('.history-item[data-id="' + eventId + '"]');
        if (!item) return;

        const btn = item.querySelector('.revert-action');
        if (btn) {
          btn.disabled = true;
          btn.textContent = '...';
        }

        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.success) {
              showToast('Edició desfeta', 'undo');
              // Refresh the history list
              refreshHistory();
              // Add system message to chat
              addBubble('system', icon('undo', 'i--default') + ' S\'ha desfet una edició de l\'historial.');
            } else {
              if (btn) {
                btn.disabled = false;
                btn.innerHTML = icon('undo', 'i--sm') + ' Desfer';
              }
              showToast(res ? res.error : 'Error desconegut', 'error');
            }
          })
          .withFailureHandler(function(err) {
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = icon('undo', 'i--sm') + ' Desfer';
            }
            showToast('Error: ' + err.message, 'error');
          })
          .revertEditById(eventId);
      }
    </script>

    <!-- v4.0: Ban Tooltip (Sprint 2) -->
    <div id="banTooltip" class="ban-tooltip">
      <span class="ban-tooltip-word" id="banTooltipWord"></span>
      <button class="ban-tooltip-btn" onclick="banSelectedWord()">
        <span class="i i--error i--sm"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></span> No usis això
      </button>
    </div>
  </body>
</html>
