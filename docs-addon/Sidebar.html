<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
      body {
        padding: 0; margin: 0;
        font-family: 'Google Sans', Roboto, Arial, sans-serif;
        background-color: #f8f9fa;
        height: 100vh; display: flex; flex-direction: column;
      }

      /* Cap√ßalera fixa */
      .header {
        background: white; padding: 12px; border-bottom: 1px solid #dadce0;
        display: flex; justify-content: space-between; align-items: center;
      }
      .header h1 { margin: 0; font-size: 16px; color: #202124; }
      .settings-btn { cursor: pointer; opacity: 0.6; font-size: 18px; }
      .settings-btn:hover { opacity: 1; }

      /* Zona de configuraci√≥ (Overlay) */
      #configPanel {
        background: #fff; padding: 15px; border-bottom: 1px solid #ddd;
        display: none; /* Ocult per defecte */
      }

      /* Zona de Xat (Scrollable) */
      #chatHistory {
        flex-grow: 1; overflow-y: auto; padding: 15px;
        display: flex; flex-direction: column; gap: 12px;
      }

      /* Bombolles de missatge */
      .msg { padding: 10px 14px; border-radius: 18px; font-size: 13px; line-height: 1.4; max-width: 85%; word-wrap: break-word; }

      .msg.user {
        align-self: flex-end;
        background-color: #d2e3fc; color: #174ea6;
        border-bottom-right-radius: 4px;
      }

      .msg.ai {
        align-self: flex-start;
        background-color: #ffffff; color: #202124; border: 1px solid #dadce0;
        border-bottom-left-radius: 4px;
      }

      .msg.system {
        align-self: center; background: none; border: none;
        font-size: 11px; color: #5f6368; text-align: center; width: 100%;
      }

      .msg.error { background-color: #fce8e6; color: #c5221f; align-self: center; }

      /* Peu de p√†gina (Input) */
      .footer {
        padding: 10px; background: white; border-top: 1px solid #dadce0;
      }
      .input-wrapper { display: flex; gap: 8px; }

      textarea {
        flex-grow: 1; height: 38px; padding: 8px; resize: none;
        border: 1px solid #dadce0; border-radius: 20px; outline: none; font-family: inherit;
      }
      textarea:focus { border-color: #1a73e8; }

      button#sendBtn {
        background: #1a73e8; color: white; border: none;
        width: 40px; height: 40px; border-radius: 50%;
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        font-size: 18px; transition: background 0.2s;
      }
      button#sendBtn:hover { background: #174ea6; }
      button#sendBtn:disabled { background: #dadce0; cursor: default; }

      .credits-info { text-align: center; font-size: 10px; color: #9aa0a6; margin-top: 6px; }

    </style>
  </head>
  <body>

    <div class="header">
      <h1>SideCar ü§ñ</h1>
      <div class="settings-btn" onclick="toggleConfig()">‚öôÔ∏è</div>
    </div>

    <div id="configPanel">
      <label style="font-size:12px; font-weight:bold;">Llic√®ncia API</label>
      <div style="display:flex; gap:5px; margin-top:5px;">
        <input type="text" id="licenseInput" placeholder="SIDECAR-..." style="flex-grow:1; padding:5px;">
        <button class="share" onclick="saveLicense()">Desar</button>
      </div>
    </div>

    <div id="chatHistory">
      <div class="msg system">Hola! Selecciona text al document i digues-me com vols modificar-lo.</div>
    </div>

    <div class="footer">
      <div class="input-wrapper">
        <textarea id="userInput" placeholder="Ex: Fes-ho m√©s formal..."></textarea>
        <button id="sendBtn" onclick="sendMessage()">‚û§</button>
      </div>
      <div id="creditsDisplay" class="credits-info"></div>
    </div>

    <script>
      // En carregar, comprovem si tenim llic√®ncia
      window.onload = function() {
        google.script.run.withSuccessHandler(function(key) {
          if (key) {
            document.getElementById('licenseInput').value = key;
          } else {
            toggleConfig(); // Si no hi ha clau, obrim config
          }
        }).getLicenseKey();

        // UX: Escoltar tecla Enter al textarea
        var input = document.getElementById('userInput');
        input.addEventListener("keydown", function(event) {
          // Si √©s Enter i NO tenim Shift premut
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault(); // Evita el salt de l√≠nia
            sendMessage(); // Envia
          }
        });
      };

      function toggleConfig() {
        var panel = document.getElementById('configPanel');
        panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
      }

      function saveLicense() {
        var key = document.getElementById('licenseInput').value;
        google.script.run.withSuccessHandler(function() {
          toggleConfig();
          addBubble('system', 'Clau guardada correctament.');
        }).setLicenseKey(key);
      }

      function addBubble(type, text) {
        var history = document.getElementById('chatHistory');
        var div = document.createElement('div');
        div.className = 'msg ' + type;
        div.innerText = text;
        history.appendChild(div);
        // Auto-scroll al final
        history.scrollTop = history.scrollHeight;
      }

      function sendMessage() {
        var input = document.getElementById('userInput');
        var text = input.value.trim();
        if (!text) return;

        // UI Updates
        addBubble('user', text);
        input.value = '';
        var btn = document.getElementById('sendBtn');
        btn.disabled = true;

        // Backend call
        google.script.run
          .withSuccessHandler(function(res) {
            btn.disabled = false;
            addBubble('ai', res.ai_response);
            document.getElementById('creditsDisplay').innerText = 'Cr√®dits: ' + res.credits;
          })
          .withFailureHandler(function(err) {
            btn.disabled = false;
            addBubble('error', err.message);
          })
          .processUserCommand(text);
      }
    </script>
  </body>
</html>
